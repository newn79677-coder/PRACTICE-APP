<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mock Test Pro</title>
    <!-- Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4CAF50" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="screen-orientation" content="portrait">
    
    <!-- Firebase SDKs v12 -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js';
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, orderBy, query, where } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js';

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCs2Ab_tFU18xj8o0qXuzIrphMT7OERNYY",
        authDomain: "practicpro-mock-0786.firebaseapp.com",
        projectId: "practicpro-mock-0786",
        storageBucket: "practicpro-mock-0786.firebasestorage.app",
        messagingSenderId: "457425256741",
        appId: "1:457425256741:web:0807a6c1333c8fb1c51acc"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Make Firebase services available globally
    window.firebaseAuth = auth;
    window.firebaseDB = db;
    window.firebaseStorage = storage;
    window.firebaseFunctions = {
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        sendEmailVerification,
        collection,
        doc,
        setDoc,
        getDoc,
        getDocs,
        addDoc,
        orderBy,
        query,
        where,
        ref,
        uploadBytes,
        getDownloadURL
    };
    
document.addEventListener('DOMContentLoaded', () => {
    if (window.firebaseFunctions) {
        // Initialize app after Firebase
        initApp();
    } else {
        console.error("Firebase is not initialized yet.");
    }
});
  </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border: #e2e8f0;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] {
            --bg-primary: #1e293b;
            --bg-secondary: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border: #334155;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            touch-action: manipulation;
        }

        /* Navbar */
        .navbar {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        .profile-toggle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #818cf8);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .profile-toggle:active {
            transform: scale(0.95);
        }

        .profile-toggle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .menu-toggle:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .nav-brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }

        /* Menu Dropdown */
        #menu-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            display: none;
            min-width: 200px;
            z-index: 101;
            overflow: hidden;
        }

        #menu-dropdown h3 {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            margin: 0;
            color: var(--primary);
            font-size: 1rem;
            text-align: center;
        }

        .menu-item {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .theme-toggle:active {
            background: var(--primary);
            color: white;
            transform: scale(0.95);
        }

        /* Container and Screens */
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .card:active {
            transform: translateY(1px);
        }

        .card-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-header h2 {
            margin: 0 0 0.5rem 0;
            color: var(--primary);
            font-size: 1.25rem;
        }

        .card-body {
            padding: 1rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 0.875rem;
            white-space: nowrap;
            min-height: 44px;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn:active:not(:disabled) {
            transform: translateY(1px);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        @media (min-width: 640px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .feature-card {
            text-align: center;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }

        /* Test Layout */
        .test-layout {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: calc(100vh - 120px);
        }

        .question-sidebar {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            order: 2;
            position: sticky;
            bottom: 0;
            z-index: 50;
        }

        .question-content {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            order: 1;
            flex: 1;
        }

        @media (min-width: 1024px) {
            .test-layout {
                flex-direction: row;
            }
            
            .question-sidebar {
                order: 1;
                width: 300px;
                position: sticky;
                top: 80px;
                height: fit-content;
                max-height: calc(100vh - 100px);
                overflow-y: auto;
            }
            
            .question-content {
                order: 2;
                flex: 1;
            }
        }

        /* Test Header with Progress and Time */
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            border-radius: 0.75rem 0.75rem 0 0;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .progress-container {
            flex: 1;
            min-width: 200px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        .test-timer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: rgba(99, 102, 241, 0.1);
        }

        /* Timers */
        .timer-display {
            background: linear-gradient(135deg, var(--success), #34d399);
            color: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.875rem;
        }

        .timer-display.warning {
            background: linear-gradient(135deg, var(--warning), #fbbf24);
            animation: pulse 1s infinite;
        }

        .timer-display.critical {
            background: linear-gradient(135deg, var(--error), #f87171);
            animation: shake 0.5s infinite;
        }

        .question-timer {
            background: linear-gradient(135deg, var(--primary), #818cf8);
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.75rem;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        /* Question Nav */
        .question-nav {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        @media (max-width: 640px) {
            .question-nav {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .question-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            min-height: 40px;
        }

        .question-btn:active {
            transform: scale(0.95);
        }

        .question-btn.unvisited {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .question-btn.visited {
            background: #f87171;
            color: white;
        }

        .question-btn.answered {
            background: #34d399;
            color: white;
        }

        .question-btn.marked {
            background: #a78bfa;
            color: white;
        }

        .question-btn.locked {
            background: #6b7280;
            color: white;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .question-btn.current {
            box-shadow: 0 0 0 2px var(--primary);
            z-index: 10;
        }

        /* Question Content */
        .question-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(129, 140, 248, 0.05));
            gap: 0.5rem;
        }

        .question-body {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .question-text {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .options-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 44px;
        }

        .option-item:active:not(.disabled) {
            transform: scale(0.98);
        }

        .option-item.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .option-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .option-item.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .option-item.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .option-radio {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s;
            margin-top: 0.25rem;
        }

        .option-item.selected .option-radio {
            border-color: var(--primary);
            background: var(--primary);
        }

        .option-item.selected .option-radio::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .question-controls {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            flex-wrap: wrap;
            background: var(--bg-secondary);
        }

        .control-group {
            display: flex;
            gap: 0.5rem;
            flex: 1;
        }

        .control-group .btn {
            flex: 1;
        }

        /* Legend */
        .legend {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .legend h4 {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.25rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 0.25rem;
            flex-shrink: 0;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            padding: 1rem;
        }

        .modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); }
            to { transform: translateY(0); }
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Messages */
        .error-message, .success-message, .info-message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
            color: var(--error);
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .info-message {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Install Button */
        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 50px;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .install-button:active {
            transform: scale(0.95);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            z-index: 1001;
            opacity: 0;
            transform: translateX(-50%) translateY(-20px);
            transition: all 0.3s ease;
            max-width: 90vw;
            text-align: center;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification.success {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .notification.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .notification.warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        /* Timetable Specific */
        .timetable-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .timetable-tab {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .timetable-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .timetable-container {
            animation: fadeIn 0.3s ease-in-out;
        }

        .schedule-entry {
            margin-bottom: 0.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background: var(--bg-secondary);
        }

        .schedule-time {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        /* Config Rows */
        .config-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            gap: 0.5rem;
        }

        .config-row label {
            font-size: 0.875rem;
            font-weight: 500;
            min-width: 150px;
        }

        .config-row input {
            max-width: 120px;
        }

        @media (max-width: 640px) {
            .config-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.25rem;
            }
            
            .config-row input {
                max-width: none;
            }
        }

        /* JSON Example */
        .copy-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .json-example {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .test-config {
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
        }

        .test-config h4 {
            margin-bottom: 0.75rem;
            color: var(--primary);
        }

        /* Stats */
        .stat-card {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        /* Explanation */
        .explanation {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid var(--primary);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .explanation h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .review-status {
            background: var(--success);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .navbar {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .nav-menu {
                order: 3;
                width: 100%;
                justify-content: space-around;
            }
            
            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
            
            .test-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .test-timer {
                align-self: center;
            }
        }

        /* Safe Area */
        @media (max-width: 767px) and (orientation: portrait) {
            body {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .question-sidebar {
                bottom: env(safe-area-inset-bottom);
            }
            
            .install-button {
                bottom: calc(20px + env(safe-area-inset-bottom));
                right: calc(20px + env(safe-area-inset-right));
            }
        }

        /* Test Security Overlay (hidden by default) */
        #test-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
        }

        #test-overlay.show {
            display: flex;
        }
    </style>
</head>
<body data-theme="light">
    <nav class="navbar">
        <div class="nav-left">
            <div class="profile-toggle" onclick="toggleProfileMenu()" id="profile-toggle">
                <span id="profile-initial">G</span>
                <img id="profile-image" style="display: none;" alt="Profile" />
            </div>
            <div class="nav-brand">üß† Mock Test Pro</div>
            <button class="menu-toggle" id="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
            <div id="menu-dropdown">
                <h3>PRO MOCK TEST</h3>
                <a href="#" class="menu-item active" onclick="showScreen('dashboard'); closeMenu();">Dashboard</a>
                <a href="#" class="menu-item" onclick="showScreen('my-tests'); closeMenu();">My Tests</a>
                <a href="#" class="menu-item" onclick="showScreen('results'); closeMenu();">Results</a>
                <a href="#" class="menu-item" onclick="showScreen('timetable'); closeMenu();">Timetable</a>
                <a href="#" class="menu-item" onclick="showScreen('notes'); closeMenu();">Notes</a>
                <a href="#" class="menu-item" onclick="showScreen('live-classes'); closeMenu();">Live Classes</a>
                <a href="#" class="menu-item" onclick="showScreen('settings'); closeMenu();">Settings</a>
                <a href="#" class="menu-item" id="auth-menu-item" onclick="showScreen('auth'); closeMenu();">Login</a>
                <a href="#" class="menu-item" id="logout-menu-item" style="display:none;" onclick="logout(); closeMenu();">Logout</a>
                <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid var(--border);">
                <button class="menu-item" style="text-align: left; width: 100%; background: none; border: none; cursor: pointer;" onclick="toggleTheme(); closeMenu();">
                    <span id="theme-icon">üåô</span> Toggle Theme
                </button>
                <a href="#" class="menu-item" onclick="showScreen('profile'); closeMenu();">Profile</a>
            </div>
        </div>
    </nav>

    <!-- Install App Button -->
    <button id="install-btn" class="install-button" style="display: none;">üì± Install App</button>

    <!-- Test Overlay for Pause -->
    <div id="test-overlay">
        <div>Test Paused</div>
        <button class="btn btn-primary" onclick="resumeTest()">Resume</button>
    </div>

    <!-- Dashboard Screen -->
    <div class="screen active" id="dashboard-screen">
        <div class="container">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                <div id="dashboard-avatar" style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #818cf8); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; position: relative; overflow: hidden; border: 2px solid var(--border);">
                    <span id="dashboard-initial">G</span>
                    <img id="dashboard-image" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none;" alt="Profile Picture" />
                </div>
                <div>
                    <h1 style="margin: 0; font-size: 1.25rem;">Welcome back, <span id="dashboard-name">Guest User</span>!</h1>
                    <p style="color: var(--text-secondary); margin: 0.25rem 0 0 0; font-size: 0.875rem;" id="dashboard-bio">Quiz enthusiast ready to learn!</p>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="card feature-card">
                    <div class="feature-icon">üìÑ</div>
                    <h3>Create New Test</h3>
                    <p>Upload questions via JSON and start your mock test</p>
                    <button class="btn btn-primary" onclick="showScreen('upload')">Get Started</button>
                </div>
                
                <div class="card feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>View Results</h3>
                    <p>Analyze your performance and track progress</p>
                    <button class="btn btn-secondary" onclick="showScreen('results')">View Results</button>
                </div>
                
                <div class="card feature-card">
                    <div class="feature-icon">üìö</div>
                    <h3>My Tests</h3>
                    <p>Access your saved tests and retake them</p>
                    <button class="btn btn-secondary" onclick="showScreen('my-tests')">Browse Tests</button>
                </div>

                <div class="card feature-card">
                    <div class="feature-icon">üìÖ</div>
                    <h3>Timetable</h3>
                    <p>Manage your study schedule and plan</p>
                    <button class="btn btn-secondary" onclick="showScreen('timetable')">View Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Screen -->
    <div class="screen" id="upload-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Upload Test Questions</h2>
                    <p>Create your custom mock test with JSON format questions</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">üìù JSON Format Instructions</label>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">Use this JSON format to prepare your questions. You can also ask any AI tool to generate questions directly in this format.</p>
                        
                        <div class="copy-container">
                            <div class="json-example" id="json-example">[
  {
    "question": "What is the capital of France?",
    "options": ["London", "Berlin", "Paris", "Madrid"],
    "correct": 2,
    "explanation": "Paris is the capital and largest city of France.",
    "marks": 1
  },
  {
    "question": "Which planet is closest to the Sun?",
    "options": ["Venus", "Mercury", "Earth", "Mars"],
    "correct": 1,
    "explanation": "Mercury is the smallest planet and closest to the Sun.",
    "marks": 2
  }
]</div>
                            <button class="copy-btn btn btn-primary" onclick="copyJsonExample()">üìã Copy</button>
                        </div>
                        
                        <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="pasteFromClipboard()">üì• Paste from Clipboard</button>
                    </div>

                    <form id="upload-form">
                        <div class="form-group">
                            <label class="form-label" for="test-title">Test Title</label>
                            <input type="text" id="test-title" class="form-input" placeholder="Enter test title" required>
                        </div>
                        
                        <div class="test-config">
                            <h4>Test Configuration</h4>
                            <div class="config-row">
                                <label for="test-duration">Duration (minutes):</label>
                                <input type="number" id="test-duration" value="60" min="1" class="form-input" required>
                            </div>
                            <div class="config-row">
                                <label for="default-marks">Default marks per question:</label>
                                <input type="number" id="default-marks" value="1" min="0" step="0.25" class="form-input">
                            </div>
                            <div class="config-row">
                                <label for="negative-marks">Negative marks:</label>
                                <input type="number" id="negative-marks" value="0" min="0" step="0.25" class="form-input">
                            </div>
                            <div class="config-row">
                                <label for="per-question-timer" style="align-self: flex-start;">Enable per-question timer:</label>
                                <input type="checkbox" id="per-question-timer" style="margin-left: auto;">
                            </div>
                            <div class="config-row" id="question-time-row" style="display: none;">
                                <label for="question-time">Time per question (seconds):</label>
                                <input type="number" id="question-time" value="60" min="10" class="form-input">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="questions-json">Questions JSON</label>
                            <textarea id="questions-json" class="form-input form-textarea" 
                                placeholder='Paste your questions JSON here...' 
                                required></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button type="button" class="btn btn-primary" onclick="loadQuestions()">Load Questions</button>
                            <button type="button" class="btn btn-secondary" onclick="showScreen('dashboard')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Preview Screen -->
    <div class="screen" id="preview-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2 id="preview-title">Test Preview</h2>
                    <p>Review your test settings before starting</p>
                </div>
                <div class="card-body">
                    <div id="test-info" class="test-config">
                        <!-- Test info will be populated here -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem; display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center;">
                        <button class="btn btn-primary" onclick="startTestFromPreview()">üöÄ Start Test</button>
                        <button class="btn btn-secondary" onclick="showScreen('upload')">‚Üê Back to Edit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Screen -->
    <div class="screen" id="test-screen">
        <div class="container">
            <!-- New Test Header with Progress and Time -->
            <div class="test-header">
                <div class="progress-container">
                    <div class="progress-info">
                        <span id="progress-text">Answered: 0/0</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="test-timer">
                    <span>‚è±Ô∏è</span>
                    <span id="top-timer-text">60:00</span>
                </div>
            </div>
            
            <div class="test-layout">
                <div class="question-sidebar">
                    <div class="timer-display" id="timer-display">
                        <div>Time Remaining</div>
                        <div id="timer-text">60:00</div>
                    </div>
                    
                    <div class="question-timer" id="question-timer" style="display: none;">
                        <div>Question Time</div>
                        <div id="question-timer-text">60</div>
                    </div>
                    
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Questions</h3>
                    <div class="question-nav" id="question-nav"></div>
                    
                    <div class="legend">
                        <h4>Legend</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--bg-secondary); border: 1px solid var(--border);"></div>
                                <span>Unvisited</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f87171;"></div>
                                <span>Visited</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #34d399;"></div>
                                <span>Answered</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #a78bfa;"></div>
                                <span>Marked</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #6b7280;"></div>
                                <span>Locked</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="question-content">
                    <div class="question-header">
                        <h2 id="question-title" style="font-size: 1.125rem; flex: 1;">Question 1</h2>
                        <div class="control-group" style="gap: 0.25rem;">
                            <button class="btn btn-warning" onclick="markForReview()" style="padding: 0.5rem 0.75rem; font-size: 0.75rem;">Mark</button>
                            <button class="btn btn-secondary" onclick="clearResponse()" style="padding: 0.5rem 0.75rem; font-size: 0.75rem;">Clear</button>
                            <button id="pause-btn" class="btn btn-warning" onclick="pauseTest()" style="padding: 0.5rem 0.75rem; font-size: 0.75rem;">Pause</button>
                        </div>
                    </div>
                    
                    <div class="question-body">
                        <div class="question-text" id="question-text">Loading...</div>
                        <ul class="options-list" id="options-list"></ul>
                    </div>
                    
                    <div class="question-controls">
                        <div class="control-group">
                            <button class="btn btn-secondary" id="prev-btn" onclick="previousQuestion()" disabled>‚Üê Prev</button>
                            <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()">Next ‚Üí</button>
                        </div>
                        <button class="btn btn-error" onclick="showSubmitModal()">Submit Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div class="screen" id="results-screen">
        <div class="container">
            <div id="results-content"></div>
        </div>
    </div>

    <!-- Review Screen -->
    <div class="screen" id="review-screen">
        <div class="container">
            <div class="test-layout">
                <div class="question-sidebar">
                    <div style="background: linear-gradient(135deg, var(--primary), #818cf8); color: white; padding: 1rem; border-radius: 0.75rem; text-align: center; margin-bottom: 1rem;">
                        <div>Review Mode</div>
                        <div style="font-size: 0.75rem;">Solutions & Explanations</div>
                    </div>
                    
                    <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">Questions</h3>
                    <div class="question-nav" id="review-question-nav"></div>
                    
                    <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="downloadResultsPDF()">üìÑ Download PDF</button>
                        <button class="btn btn-secondary" onclick="showScreen('dashboard')">Dashboard</button>
                    </div>
                </div>

                <div class="question-content">
                    <div class="question-header">
                        <h2 id="review-question-title" style="font-size: 1.125rem;">Question 1</h2>
                        <div id="review-status" class="review-status">CORRECT</div>
                    </div>
                    
                    <div class="question-body">
                        <div class="question-text" id="review-question-text">Loading...</div>
                        <ul class="options-list" id="review-options-list"></ul>
                        <div id="explanation" class="explanation" style="display: none;">
                            <h4>Explanation</h4>
                            <div id="explanation-text"></div>
                        </div>
                    </div>
                    
                    <div class="question-controls">
                        <div class="control-group">
                            <button class="btn btn-secondary" id="review-prev-btn" onclick="prevReview()" disabled>‚Üê Prev</button>
                            <button class="btn btn-primary" id="review-next-btn" onclick="nextReview()">Next ‚Üí</button>
                        </div>
                        <button class="btn btn-warning" onclick="retakeTest()">Retake Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Tests Screen -->
    <div class="screen" id="my-tests-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>My Tests</h2>
                    <p>Access and manage your saved tests</p>
                </div>
                <div class="card-body">
                    <div id="saved-tests">
                        <div style="text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 1rem;">Loading your tests...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div class="screen" id="auth-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>üîê Login / Signup</h2>
                    <p>Access your account to continue</p>
                </div>
                <div class="card-body">
                    <div id="auth-loading" style="display: none; text-align: center; margin: 2rem 0;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 1rem;">Processing...</p>
                    </div>
                    
                    <form id="auth-form">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="auth-email" class="form-input" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="auth-password" class="form-input" placeholder="Enter password" required minlength="6">
                        </div>
                        <div style="display:flex; gap:0.75rem; margin-top:1rem; flex-wrap: wrap;">
                            <button type="button" class="btn btn-primary" onclick="login()">Login</button>
                            <button type="button" class="btn btn-secondary" onclick="signup()">Signup</button>
                        </div>
                    </form>
                    
                    <div id="auth-message" class="error-message" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Screen -->
    <div class="screen" id="profile-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>User Profile</h2>
                    <p>Manage your profile information</p>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 2rem;">
                        <div style="position: relative; margin-bottom: 1rem;">
                            <div id="profile-avatar" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #818cf8); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; position: relative; overflow: hidden; cursor: pointer; border: 3px solid var(--border);" onclick="document.getElementById('profile-picture-input').click()">
                                <span id="profile-initial-display">G</span>
                                <img id="profile-image-display" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none;" alt="Profile Picture" />
                                <div style="position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-primary); cursor: pointer; font-size: 0.75rem;">
                                    üì∑
                                </div>
                            </div>
                            <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                        </div>
                        <button class="btn btn-secondary" onclick="removeProfilePicture()">Remove Picture</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="profile-name">Full Name</label>
                        <input type="text" id="profile-name" class="form-input" placeholder="Enter your full name" value="Guest User">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="profile-email">Email</label>
                        <input type="email" id="profile-email" class="form-input" placeholder="Enter your email" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="profile-bio">Bio</label>
                        <textarea id="profile-bio" class="form-input" placeholder="Tell us about yourself..." rows="3" style="resize: vertical;">Quiz enthusiast ready to learn!</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Member Since</label>
                        <p style="margin: 0; color: var(--text-secondary); padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;" id="member-since">Today</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary);" id="tests-taken">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Tests Taken</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);" id="avg-score">0%</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Average Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);" id="best-score">0%</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">Best Score</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveProfile()">üíæ Save Profile</button>
                        <button class="btn btn-secondary" onclick="showScreen('dashboard')">‚Üê Back to Dashboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timetable Screen -->
    <div class="screen" id="timetable-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>My Timetable</h2>
                    <p>Manage your study schedule</p>
                </div>
                <div class="card-body">
                    <div class="timetable-nav">
                        <button class="timetable-tab active" onclick="showTimetableTab('schedule')">All Schedules</button>
                        <button class="timetable-tab" onclick="showTimetableTab('create')">Create Entry</button>
                        <button class="timetable-tab" onclick="showTimetableTab('import')">Import HTML</button>
                    </div>

                    <div id="schedule-tab" class="timetable-container">
                        <h3 style="font-size: 1.125rem; margin-bottom: 1rem;">Your Schedules</h3>
                        <div id="schedule-list">
                            <div style="text-align: center; padding: 2rem;">
                                <div class="loading-spinner"></div>
                                <p style="margin-top: 1rem;">Loading schedules...</p>
                            </div>
                        </div>
                    </div>

                    <div id="create-tab" class="timetable-container" style="display: none;">
                        <h3 style="font-size: 1.125rem; margin-bottom: 1rem;">Create Schedule Entry</h3>
                        <form id="schedule-form">
                            <div class="form-group">
                                <label class="form-label">Day of Week</label>
                                <select id="schedule-day" class="form-input" required>
                                    <option value="">Select Day</option>
                                    <option value="sunday">Sunday</option>
                                    <option value="monday">Monday</option>
                                    <option value="tuesday">Tuesday</option>
                                    <option value="wednesday">Wednesday</option>
                                    <option value="thursday">Thursday</option>
                                    <option value="friday">Friday</option>
                                    <option value="saturday">Saturday</option>
                                </select>
                            </div>
                            <div class="config-row">
                                <label>Start Time:</label>
                                <input type="time" id="schedule-start" class="form-input" required>
                            </div>
                            <div class="config-row">
                                <label>End Time:</label>
                                <input type="time" id="schedule-end" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subject/Activity</label>
                                <input type="text" id="schedule-subject" class="form-input" placeholder="e.g., Mathematics, Study Session" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes (Optional)</label>
                                <textarea id="schedule-notes" class="form-input" placeholder="Additional details..." rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Entry</button>
                        </form>
                    </div>

                    <div id="import-tab" class="timetable-container" style="display: none;">
                        <h3 style="font-size: 1.125rem; margin-bottom: 1rem;">Import HTML Timetable</h3>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">Paste your complete HTML timetable code below. It will parse and add entries for all days.</p>
                        <div class="form-group">
                            <label class="form-label">HTML Code</label>
                            <textarea id="html-timetable" class="form-input" placeholder="Paste your HTML timetable code here..." rows="8"></textarea>
                        </div>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="importHTMLTimetable()">Import Timetable</button>
                            <button class="btn btn-secondary" onclick="clearHTMLTimetable()">Clear</button>
                        </div>
                        
                        <div id="html-preview" style="display: none; margin-top: 1rem; border: 2px dashed var(--border); padding: 1rem; border-radius: 0.5rem;">
                            <h4>Preview:</h4>
                            <div id="html-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div class="screen" id="settings-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Settings</h2>
                    <p>Customize your experience</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                            <input type="checkbox" id="sound-enabled" checked onchange="toggleSound()"> 
                            Enable sound effects
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                            <input type="checkbox" id="notifications-enabled" checked onchange="toggleNotifications()"> 
                            Show notifications
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem;">
                            <input type="checkbox" id="auto-submit" checked> 
                            Auto submit when time expires
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                        <h4 style="color: var(--error); margin-bottom: 1rem; font-size: 1rem;">Danger Zone</h4>
                        <button class="btn btn-error" onclick="clearAllData()">Clear All Data</button>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">This will delete all your tests, results, and settings. This action cannot be undone.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notes Screen -->
    <div class="screen" id="notes-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Study Notes</h2>
                    <p>Download study notes uploaded by admins</p>
                </div>
                <div class="card-body">
                    <div id="notes-list">
                        <div style="text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 1rem;">Loading notes...</p>
                        </div>
                    </div>
                    <div id="notes-upload" style="margin-top:1rem; display:none; padding: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary);">
                        <h4>Upload New Note (Admin Only)</h4>
                        <div style="display: flex; gap: 0.75rem; align-items: center; margin-top: 1rem; flex-wrap: wrap;">
                            <input type="file" id="note-file" class="form-input" style="flex: 1; min-width: 200px;" accept=".pdf,.doc,.docx,.txt,.ppt,.pptx" />
                            <button class="btn btn-primary" onclick="uploadNote()">Upload Note</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Classes Screen -->
    <div class="screen" id="live-classes-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Live Classes</h2>
                    <p>Join upcoming live sessions</p>
                </div>
                <div class="card-body">
                    <div id="live-list">
                        <div style="text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 1rem;">Loading live classes...</p>
                        </div>
                    </div>
                    <div id="live-create" style="margin-top:1rem; display:none; padding: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary);">
                        <h4>Create Live Class (Admin Only)</h4>
                        <div class="form-group">
                            <label class="form-label" for="live-title">Class Title</label>
                            <input type="text" id="live-title" class="form-input" placeholder="Class Title" />
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="live-date">Date & Time</label>
                            <input type="datetime-local" id="live-date" class="form-input" />
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="live-link">Meeting Link (e.g., Zoom, Meet)</label>
                            <input type="url" id="live-link" class="form-input" placeholder="https://meet.google.com/..." />
                        </div>
                        <button class="btn btn-primary" onclick="createLiveClass()">Create Live Class</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Modal -->
    <div class="modal" id="submit-modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 1rem;">Submit Test?</h3>
            <p style="margin-bottom: 1.5rem;">Are you sure you want to submit? You cannot change answers after submission.</p>
            <div id="submit-summary" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-error" onclick="submitTest()">Submit</button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loading-modal">
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <p style="margin-top: 1rem; text-align: center;">Loading...</p>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div id="notification-text"></div>
    </div>

    <script>
        // Global variables
        let currentTest = null;
        let currentQuestion = 0;
        let userAnswers = {};
        let questionStatus = {};
        let lockedQuestions = new Set();
        let testTimer = null;
        let questionTimer = null;
        let timeRemaining = 0;
        let questionTimeRemaining = 0;
        let savedTests = [];
        let testResults = [];
        let currentResult = null;
        let soundEnabled = true;
        let previewTest = null;
        let scheduleEntries = [];
        let isPaused = false;
        let testKeyListener = null;
        let adminEmail = 'jaid121314@gamil.com';

        // User profile data
        let userProfile = {
            name: 'Guest User',
            email: '',
            bio: 'Quiz enthusiast ready to learn!',
            profilePicture: null,
            memberSince: new Date().toISOString()
        };

        // Initialize app
        function initApp() {
            loadSavedData();
            setupFormHandlers();
            updateTodayDate();
            setupPWA();
            showNotification('Welcome to Mock Test Pro!', 'success');
            
            // Handle per-question timer toggle
            const perQuestionTimer = document.getElementById('per-question-timer');
            if (perQuestionTimer) {
                perQuestionTimer.addEventListener('change', function() {
                    document.getElementById('question-time-row').style.display = this.checked ? 'flex' : 'none';
                });
            }
            
            // Set auto-rotate
            const autoRotate = localStorage.getItem('autoRotate') !== 'false';
            const autoRotateChk = document.getElementById('auto-rotate');
            if (autoRotateChk) autoRotateChk.checked = autoRotate;
            if (autoRotate) {
                try {
                    screen.orientation.unlock();
                } catch (e) {}
            }

            // Online status
            if (!navigator.onLine) {
                showNotification('You are offline. Please check your connection.', 'error');
            }
            window.addEventListener('online', () => showNotification('You are back online!', 'success'));
            window.addEventListener('offline', () => showNotification('You are offline. Please check your connection.', 'error'));

            // Firebase auth listener
            window.firebaseFunctions.onAuthStateChanged(window.firebaseAuth, (user) => {
                if (user) {
                    userProfile.email = user.email;
                    userProfile.name = user.displayName || userProfile.name;
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                    document.getElementById('auth-menu-item').style.display = 'none';
                    document.getElementById('logout-menu-item').style.display = 'block';
                    updateProfileDisplay();
                    showNotification('Logged in successfully!', 'success');
                } else {
                    document.getElementById('auth-menu-item').style.display = 'block';
                    document.getElementById('logout-menu-item').style.display = 'none';
                }
                // Reload screens that depend on auth
                if (document.getElementById('notes-screen').classList.contains('active')) loadNotes();
                if (document.getElementById('live-classes-screen').classList.contains('active')) loadLiveClasses();
                if (document.getElementById('timetable-screen').classList.contains('active')) updateSchedule();
            });
        }

        // Menu functions
        function toggleMenu() {
            const dropdown = document.getElementById('menu-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            playClickSound();
        }

        function closeMenu() {
            document.getElementById('menu-dropdown').style.display = 'none';
        }

        function toggleProfileMenu() {
            showScreen('profile');
            closeMenu();
        }

        // Screen navigation
        function showScreen(screenId) {
            playClickSound();
            closeMenu();
            
            document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
            const targetScreen = document.getElementById(screenId + '-screen');
            if (targetScreen) targetScreen.classList.add('active');
            
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            const menuItems = document.querySelectorAll('.menu-item');
            for (let item of menuItems) {
                if (item.textContent.toLowerCase().includes(screenId)) {
                    item.classList.add('active');
                    break;
                }
            }

            // Load content
            if (screenId === 'my-tests') loadMyTests();
            if (screenId === 'results') loadResults();
            if (screenId === 'timetable') updateSchedule();
            if (screenId === 'notes') loadNotes();
            if (screenId === 'live-classes') loadLiveClasses();
            if (screenId === 'test' || screenId === 'review') {
                document.querySelector('.navbar').style.display = 'block'; // Show for review
            }
        }

        // Timetable tab
        function showTimetableTab(tabName) {
            document.querySelectorAll('.timetable-container').forEach(container => container.style.display = 'none');
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) targetTab.style.display = 'block';
            
            document.querySelectorAll('.timetable-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            playClickSound();
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            body.setAttribute('data-theme', body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
            icon.textContent = body.getAttribute('data-theme') === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', body.getAttribute('data-theme'));
            playClickSound();
        }

        // Sound functions
        function playClickSound() {
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {}
        }

        function playSuccessSound() {
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 600;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {}
        }

        // Copy and paste functions
        function copyJsonExample() {
            const jsonText = document.getElementById('json-example').textContent;
            navigator.clipboard.writeText(jsonText).then(() => showNotification('JSON format copied!', 'success')).catch(() => showNotification('Failed to copy.', 'error'));
            playClickSound();
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('questions-json').value = text;
                showNotification('Pasted from clipboard!', 'success');
            } catch (err) {
                showNotification('Failed to paste.', 'error');
            }
            playClickSound();
        }

        // Load saved data
        function loadSavedData() {
            const defaultProfile = { name: 'Guest User', email: '', bio: 'Quiz enthusiast ready to learn!', profilePicture: null, memberSince: new Date().toISOString() };
            try {
                savedTests = JSON.parse(localStorage.getItem('mockTests') || '[]');
                testResults = JSON.parse(localStorage.getItem('testResults') || '[]');
                userProfile = JSON.parse(localStorage.getItem('userProfile') || JSON.stringify(defaultProfile));
                scheduleEntries = JSON.parse(localStorage.getItem('scheduleEntries') || '[]');
                soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
                
                if (document.getElementById('sound-enabled')) document.getElementById('sound-enabled').checked = soundEnabled;
                updateProfileDisplay();
                updateSchedule();
            } catch (e) {
                console.error('Error loading data:', e);
                savedTests = [];
                testResults = [];
                userProfile = defaultProfile;
                scheduleEntries = [];
                soundEnabled = true;
            }
        }

        // Update profile display
        function updateProfileDisplay() {
            if (document.getElementById('profile-name')) document.getElementById('profile-name').value = userProfile.name;
            if (document.getElementById('profile-email')) document.getElementById('profile-email').value = userProfile.email || '';
            if (document.getElementById('profile-bio')) document.getElementById('profile-bio').value = userProfile.bio;
            if (document.getElementById('member-since')) document.getElementById('member-since').textContent = new Date(userProfile.memberSince).toLocaleDateString();
            
            if (document.getElementById('dashboard-name')) document.getElementById('dashboard-name').textContent = userProfile.name;
            if (document.getElementById('dashboard-bio')) document.getElementById('dashboard-bio').textContent = userProfile.bio;
            
            const initial = userProfile.name.charAt(0).toUpperCase();
            ['profile-initial', 'dashboard-initial', 'profile-initial-display'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = initial;
            });

            const imageEls = ['profile-image', 'dashboard-image', 'profile-image-display'];
            imageEls.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (userProfile.profilePicture) {
                        el.src = userProfile.profilePicture;
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'none';
                    }
                }
            });
            
            const testsTaken = testResults.length;
            const avgScore = testsTaken > 0 ? Math.round(testResults.reduce((sum, r) => sum + r.percentage, 0) / testsTaken) : 0;
            const bestScore = testsTaken > 0 ? Math.max(...testResults.map(r => r.percentage)) : 0;
            
            ['tests-taken', 'avg-score', 'best-score'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (id === 'tests-taken') el.textContent = testsTaken;
                    else el.textContent = (id === 'avg-score' ? avgScore : bestScore) + '%';
                }
            });
        }

        // Save profile
        function saveProfile() {
            playClickSound();
            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();
            if (!name) return showNotification('Please enter your name', 'error');
            userProfile.name = name;
            userProfile.email = email;
            userProfile.bio = bio || 'Quiz enthusiast ready to learn!';
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateProfileDisplay();
            playSuccessSound();
            showNotification('Profile saved!', 'success');
        }

        // Profile picture upload
        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.type.startsWith('image/') || file.size > 5 * 1024 * 1024) {
                return showNotification('Invalid image file (max 5MB)', 'error');
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                userProfile.profilePicture = e.target.result;
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                updateProfileDisplay();
                playSuccessSound();
                showNotification('Profile picture updated!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function removeProfilePicture() {
            playClickSound();
            userProfile.profilePicture = null;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateProfileDisplay();
            showNotification('Profile picture removed', 'success');
        }

        // Setup form handlers
        function setupFormHandlers() {
            const profileInput = document.getElementById('profile-picture-input');
            if (profileInput) profileInput.addEventListener('change', handleProfilePictureUpload);
            
            const scheduleForm = document.getElementById('schedule-form');
            if (scheduleForm) scheduleForm.addEventListener('submit', (e) => { e.preventDefault(); addScheduleEntry(); });
        }

        // Update today date
        function updateTodayDate() {
            const today = new Date();
            const dateEl = document.getElementById('today-date');
            if (dateEl) dateEl.textContent = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Load questions
        function loadQuestions() {
            const title = document.getElementById('test-title').value.trim();
            const duration = parseInt(document.getElementById('test-duration').value);
            const jsonText = document.getElementById('questions-json').value.trim();
            const defaultMarks = parseFloat(document.getElementById('default-marks').value) || 1;
            const negativeMarks = parseFloat(document.getElementById('negative-marks').value) || 0;
            const perQuestionTimer = document.getElementById('per-question-timer').checked;
            const questionTime = parseInt(document.getElementById('question-time').value) || 60;

            if (!title || !duration || !jsonText) return showNotification('Fill all required fields', 'error');

            try {
                const questions = JSON.parse(jsonText);
                if (!Array.isArray(questions) || questions.length === 0) throw new Error('Invalid format - must be array of questions');
                questions.forEach((q, i) => {
                    if (!q.question || !Array.isArray(q.options) || typeof q.correct !== 'number') throw new Error(`Invalid question ${i + 1}`);
                    if (!q.marks) q.marks = defaultMarks;
                });

                previewTest = {
                    id: Date.now(),
                    title, duration, questions, defaultMarks, negativeMarks, perQuestionTimer, questionTime,
                    created: new Date().toISOString()
                };

                playSuccessSound();
                showNotification('Questions loaded!', 'success');
                showTestPreview();
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Show test preview
        function showTestPreview() {
            showScreen('preview');
            document.getElementById('preview-title').textContent = previewTest.title;
            const totalMarks = previewTest.questions.reduce((sum, q) => sum + q.marks, 0);
            document.getElementById('test-info').innerHTML = `
                <h4 style="margin-bottom: 1rem; color: var(--primary);">Test Configuration</h4>
                <div class="config-row"><strong>Title:</strong> ${previewTest.title}</div>
                <div class="config-row"><strong>Questions:</strong> ${previewTest.questions.length}</div>
                <div class="config-row"><strong>Duration:</strong> ${previewTest.duration} minutes</div>
                <div class="config-row"><strong>Total Marks:</strong> ${totalMarks}</div>
                <div class="config-row"><strong>Negative Marks:</strong> ${previewTest.negativeMarks}</div>
                <div class="config-row"><strong>Per-Question Timer:</strong> ${previewTest.perQuestionTimer ? `Yes (${previewTest.questionTime}s)` : 'No'}</div>
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 0.5rem; border-left: 4px solid var(--primary);">
                    <h5 style="margin-bottom: 0.75rem;">Instructions:</h5>
                    <ul style="margin-left: 1rem; line-height: 1.6; font-size: 0.875rem;">
                        <li>Read each question carefully</li>
                        <li>Navigate using Prev/Next</li>
                        <li>Mark for review if unsure</li>
                        <li>${previewTest.perQuestionTimer ? '<li>Time limit per question</li>' : ''}
                        <li>Submit when done</li>
                    </ul>
                </div>
            `;
        }

        // Start test
        function startTestFromPreview() {
            if (!previewTest) return;
            currentTest = previewTest;
            currentQuestion = 0;
            userAnswers = {};
            questionStatus = {};
            lockedQuestions = new Set();
            timeRemaining = currentTest.duration * 60;
            questionTimeRemaining = currentTest.perQuestionTimer ? currentTest.questionTime : 0;
            isPaused = false;

            currentTest.questions.forEach((_, i) => questionStatus[i] = 'unvisited');

            if (!savedTests.find(t => t.id === currentTest.id)) {
                savedTests.push(currentTest);
                localStorage.setItem('mockTests', JSON(savedTests));
            }

            showScreen('test');
            renderQuestionNav();
            loadQuestion();
            startTimer();
            updateProgress(); // Initialize progress display
            if (currentTest.perQuestionTimer) startQuestionTimer();

            // Security measures
            setupTestSecurity();

            showNotification('Test started! Good luck!', 'success');
        }

        // Setup test security
        function setupTestSecurity() {
            // Hide navbar
            document.querySelector('.navbar').style.display = 'none';

            // Fullscreen
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(() => {});

            // Prevent keys
            testKeyListener = (e) => {
                const forbidden = ['F12', 'F5', 'Escape', 'Tab'];
                if (forbidden.includes(e.key) || (e.ctrlKey && e.key === 'u') || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    e.preventDefault();
                    return false;
                }
            };
            document.addEventListener('keydown', testKeyListener);

            // Prevent context menu
            document.addEventListener('contextmenu', (e) => e.preventDefault());

            // Visibility change pause
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && !isPaused) pauseTest();
            });

            // Update pause btn
            document.getElementById('pause-btn').textContent = 'Pause';
        }

        // End test security
        function endTestSecurity() {
            document.querySelector('.navbar').style.display = 'flex';
            if (document.exitFullscreen) document.exitFullscreen();
            if (testKeyListener) {
                document.removeEventListener('keydown', testKeyListener);
                testKeyListener = null;
            }
            document.removeEventListener('contextmenu', (e) => e.preventDefault());
            document.removeEventListener('visibilitychange', () => {});
        }

        // Pause test
        function pauseTest() {
            isPaused = !isPaused;
            const overlay = document.getElementById('test-overlay');
            const btn = document.getElementById('pause-btn');
            if (isPaused) {
                clearInterval(testTimer);
                clearInterval(questionTimer);
                overlay.classList.add('show');
                btn.textContent = 'Resume';
                showNotification('Test paused', 'warning');
            } else {
                overlay.classList.remove('show');
                startTimer();
                if (currentTest.perQuestionTimer) startQuestionTimer();
                btn.textContent = 'Pause';
                showNotification('Test resumed', 'success');
            }
            playClickSound();
        }

        function resumeTest() {
            pauseTest();
        }

        // Update progress display
        function updateProgress() {
            if (!currentTest) return;
            
            const answered = Object.keys(userAnswers).length;
            const total = currentTest.questions.length;
            const percent = Math.round((answered / total) * 100);
            
            document.getElementById('progress-text').textContent = `Answered: ${answered}/${total}`;
            document.getElementById('progress-percent').textContent = `${percent}%`;
            document.getElementById('progress-fill').style.width = `${percent}%`;
        }

        // Timers
        function startTimer() {
            const timerText = document.getElementById('timer-text');
            const topTimerText = document.getElementById('top-timer-text');
            const timerDisplay = document.getElementById('timer-display');
            clearInterval(testTimer);
            testTimer = setInterval(() => {
                if (isPaused) return;
                timeRemaining--;
                const min = Math.floor(timeRemaining / 60);
                const sec = timeRemaining % 60;
                const timeStr = `${min}:${sec.toString().padStart(2, '0')}`;
                timerText.textContent = timeStr;
                topTimerText.textContent = timeStr;
                timerDisplay.className = timeRemaining <= 60 ? 'timer-display critical' : (timeRemaining <= 300 ? 'timer-display warning' : 'timer-display');
                if (timeRemaining <= 0) {
                    clearInterval(testTimer);
                    if (document.getElementById('auto-submit')?.checked) submitTest();
                    else showSubmitModal();
                }
            }, 1000);
        }

        function startQuestionTimer() {
            const qTimerDisplay = document.getElementById('question-timer');
            const qTimerText = document.getElementById('question-timer-text');
            qTimerDisplay.style.display = 'block';
            questionTimeRemaining = currentTest.questionTime;
            clearInterval(questionTimer);
            questionTimer = setInterval(() => {
                if (isPaused) return;
                questionTimeRemaining--;
                qTimerText.textContent = questionTimeRemaining;
                qTimerDisplay.className = questionTimeRemaining <= 5 ? 'question-timer critical' : (questionTimeRemaining <= 10 ? 'question-timer warning' : 'question-timer');
                if (questionTimeRemaining <= 0) {
                    clearInterval(questionTimer);
                    lockedQuestions.add(currentQuestion);
                    questionStatus[currentQuestion] = 'locked';
                    updateQuestionNav();
                    showNotification('Time up for question!', 'warning');
                    if (currentQuestion < currentTest.questions.length - 1) nextQuestion();
                }
            }, 1000);
        }

        // Question nav
        function renderQuestionNav() {
            const nav = document.getElementById('question-nav');
            nav.innerHTML = '';
            currentTest.questions.forEach((_, i) => {
                const btn = document.createElement('button');
                btn.className = `question-btn ${questionStatus[i] || 'unvisited'}${i === currentQuestion ? ' current' : ''}${lockedQuestions.has(i) ? ' locked' : ''}`;
                btn.textContent = i + 1;
                if (!lockedQuestions.has(i)) btn.onclick = () => goToQuestion(i);
                nav.appendChild(btn);
            });
        }

        function updateQuestionNav() {
            const btns = document.querySelectorAll('#question-nav .question-btn');
            btns.forEach((btn, i) => {
                btn.className = `question-btn ${questionStatus[i] || 'unvisited'}${i === currentQuestion ? ' current' : ''}${lockedQuestions.has(i) ? ' locked' : ''}`;
            });
        }

        function goToQuestion(i) {
            if (lockedQuestions.has(i)) return showNotification('Question locked!', 'error');
            currentQuestion = i;
            questionStatus[currentQuestion] = questionStatus[currentQuestion] || 'visited';
            loadQuestion();
            updateQuestionNav();
            updateProgress();
            if (currentTest.perQuestionTimer) {
                questionTimeRemaining = currentTest.questionTime;
                startQuestionTimer();
            }
            playClickSound();
        }

        // Load question
        function loadQuestion() {
            const q = currentTest.questions[currentQuestion];
            document.getElementById('question-title').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('question-text').innerHTML = q.question.replace(/\n/g, '<br>'); // Support line breaks

            const list = document.getElementById('options-list');
            list.innerHTML = '';
            q.options.forEach((opt, i) => {
                const li = document.createElement('li');
                li.className = `option-item ${userAnswers[currentQuestion] === i ? 'selected' : ''} ${lockedQuestions.has(currentQuestion) ? 'disabled' : ''}`;
                li.innerHTML = `<span class="option-radio"></span><span>${opt}</span>`;
                if (!lockedQuestions.has(currentQuestion)) li.onclick = () => selectOption(i);
                list.appendChild(li);
            });

            document.getElementById('prev-btn').disabled = currentQuestion === 0;
            document.getElementById('next-btn').disabled = currentQuestion === currentTest.questions.length - 1;
        }

        function selectOption(i) {
            if (lockedQuestions.has(currentQuestion)) return showNotification('Question locked!', 'error');
            userAnswers[currentQuestion] = i;
            questionStatus[currentQuestion] = 'answered';
            updateQuestionNav();
            updateProgress();
            loadQuestion();
            playClickSound();
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadQuestion();
                updateQuestionNav();
                updateProgress();
                if (currentTest.perQuestionTimer) {
                    questionTimeRemaining = currentTest.questionTime;
                    startQuestionTimer();
                }
                playClickSound();
            }
        }

        function nextQuestion() {
            if (currentQuestion < currentTest.questions.length - 1) {
                currentQuestion++;
                questionStatus[currentQuestion] = questionStatus[currentQuestion] || 'visited';
                loadQuestion();
                updateQuestionNav();
                updateProgress();
                if (currentTest.perQuestionTimer) {
                    questionTimeRemaining = currentTest.questionTime;
                    startQuestionTimer();
                }
                playClickSound();
            }
        }

        function markForReview() {
            if (lockedQuestions.has(currentQuestion)) return showNotification('Cannot mark locked question', 'error');
            questionStatus[currentQuestion] = questionStatus[currentQuestion] === 'marked' ? 'answered' : 'marked';
            updateQuestionNav();
            showNotification(`Question ${questionStatus[currentQuestion] === 'marked' ? 'marked' : 'unmarked'} for review`, 'success');
            playSuccessSound();
        }

        function clearResponse() {
            if (lockedQuestions.has(currentQuestion)) return showNotification('Cannot clear locked question', 'error');
            delete userAnswers[currentQuestion];
            questionStatus[currentQuestion] = 'visited';
            updateQuestionNav();
            updateProgress();
            loadQuestion();
            showNotification('Response cleared', 'success');
            playClickSound();
        }

        // Submit modal
        function showSubmitModal() {
            const answered = Object.keys(userAnswers).length;
            const total = currentTest.questions.length;
            const marked = Object.values(questionStatus).filter(s => s === 'marked').length;
            const unvisited = total - answered - marked;
            document.getElementById('submit-summary').innerHTML = `
                <p><strong>Answered:</strong> ${answered}/${total}</p>
                <p><strong>Marked:</strong> ${marked}</p>
                <p><strong>Not Visited:</strong> ${unvisited}</p>
                <p><strong>Locked:</strong> ${lockedQuestions.size}</p>
            `;
            document.getElementById('submit-modal').classList.add('show');
            playClickSound();
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('show'));
            playClickSound();
        }

        // Submit test
        function submitTest() {
            clearInterval(testTimer);
            clearInterval(questionTimer);
            closeModal();
            endTestSecurity();

            let score = 0, correct = 0, incorrect = 0;
            const totalMarks = currentTest.questions.reduce((sum, q) => sum + q.marks, 0);

            currentTest.questions.forEach((q, i) => {
                const ans = userAnswers[i];
                if (ans === q.correct) {
                    score += q.marks;
                    correct++;
                } else if (ans !== undefined) {
                    score -= currentTest.negativeMarks;
                    incorrect++;
                }
            });

            const percentage = totalMarks > 0 ? Math.round((score / totalMarks) * 100) : 0;
            const result = {
                testId: currentTest.id,
                title: currentTest.title,
                score, totalMarks, percentage, correct, incorrect,
                answers: {...userAnswers},
                date: new Date().toISOString()
            };

            testResults.push(result);
            localStorage.setItem('testResults', JSON.stringify(testResults));
            currentResult = result;

            // Save to Firebase
            if (window.firebaseAuth.currentUser) {
                window.firebaseFunctions.setDoc(
                    window.firebaseFunctions.doc(window.firebaseDB, 'results', `${window.firebaseAuth.currentUser.uid}_${result.testId}_${Date.now()}`),
                    result
                ).catch(e => console.error('Firebase save error:', e));
            }

            showScreen('results');
            displayResults();
            playSuccessSound();
            showNotification('Test submitted successfully!', 'success');
        }

        // Display results
        function displayResults() {
            const content = document.getElementById('results-content');
            content.innerHTML = '';

            if (!currentResult) {
                content.innerHTML = '<div class="info-message">No results available. Take a test!</div>';
                return;
            }

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <h2>${currentResult.title}</h2>
                    <p>Taken on ${new Date(currentResult.date).toLocaleString()}</p>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 2rem; text-align: center;">
                        <div><div style="font-size: 1.5rem; color: var(--primary);">${currentResult.score}/${currentResult.totalMarks}</div><div style="color: var(--text-secondary); font-size: 0.875rem;">Score</div></div>
                        <div><div style="font-size: 1.5rem; color: var(--success);">${currentResult.percentage}%</div><div style="color: var(--text-secondary); font-size: 0.875rem;">Percentage</div></div>
                        <div><div style="font-size: 1.5rem; color: var(--success);">${currentResult.correct}</div><div style="color: var(--text-secondary); font-size: 0.875rem;">Correct</div></div>
                        <div><div style="font-size: 1.5rem; color: var(--error);">${currentResult.incorrect}</div><div style="color: var(--text-secondary); font-size: 0.875rem;">Incorrect</div></div>
                    </div>
                    <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="reviewTest()">Review Answers</button>
                        <button class="btn btn-success" onclick="downloadResultsPDF()">Download PDF Report</button>
                        <button class="btn btn-secondary" onclick="showScreen('dashboard')">Dashboard</button>
                    </div>
                </div>
            `;
            content.appendChild(card);
        }

        // Review test
        function reviewTest() {
            showScreen('review');
            currentQuestion = 0;
            renderReviewQuestionNav();
            loadReviewQuestion();
            endTestSecurity(); // Ensure navbar visible for review
        }

        // Review nav
        function renderReviewQuestionNav() {
            const nav = document.getElementById('review-question-nav');
            nav.innerHTML = '';
            currentTest.questions.forEach((q, i) => {
                const status = userAnswers[i] === q.correct ? 'answered' : (userAnswers[i] !== undefined ? 'visited' : 'unvisited');
                const btn = document.createElement('button');
                btn.className = `question-btn ${status} ${i === currentQuestion ? ' current' : ''}`;
                btn.textContent = i + 1;
                btn.onclick = () => goToReviewQuestion(i);
                nav.appendChild(btn);
            });
        }

        function goToReviewQuestion(i) {
            currentQuestion = i;
            loadReviewQuestion();
            renderReviewQuestionNav();
            playClickSound();
        }

        function loadReviewQuestion() {
            const q = currentTest.questions[currentQuestion];
            document.getElementById('review-question-title').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('review-question-text').innerHTML = q.question.replace(/\n/g, '<br>');

            const status = userAnswers[currentQuestion] === q.correct ? 'CORRECT' : (userAnswers[currentQuestion] !== undefined ? 'INCORRECT' : 'NOT ATTEMPTED');
            const statusEl = document.getElementById('review-status');
            statusEl.textContent = status;
            statusEl.style.background = status === 'CORRECT' ? 'var(--success)' : (status === 'INCORRECT' ? 'var(--error)' : 'var(--warning)');

            const list = document.getElementById('review-options-list');
            list.innerHTML = '';
            q.options.forEach((opt, i) => {
                const li = document.createElement('li');
                li.className = `option-item ${userAnswers[currentQuestion] === i ? 'selected' : ''} ${i === q.correct ? 'correct' : (userAnswers[currentQuestion] === i && i !== q.correct ? 'incorrect' : '')} disabled`;
                li.innerHTML = `<span class="option-radio"></span><span>${opt}</span>`;
                list.appendChild(li);
            });

            const expl = document.getElementById('explanation');
            const explText = document.getElementById('explanation-text');
            if (q.explanation) {
                expl.style.display = 'block';
                explText.textContent = q.explanation;
            } else {
                expl.style.display = 'none';
            }

            document.getElementById('review-prev-btn').disabled = currentQuestion === 0;
            document.getElementById('review-next-btn').disabled = currentQuestion === currentTest.questions.length - 1;
        }

        function prevReview() {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadReviewQuestion();
                renderReviewQuestionNav();
                playClickSound
                }
        }

        function nextReview() {
            if (currentQuestion < currentTest.questions.length - 1) {
                currentQuestion++;
                loadReviewQuestion();
                renderReviewQuestionNav();
                playClickSound();
            }
        }

        function retakeTest() {
            previewTest = currentTest;
            showTestPreview();
        }

        function downloadResultsPDF() {
            showNotification('PDF download coming soon!', 'info');
        }

        // My tests
        function loadMyTests() {
            const div = document.getElementById('saved-tests');
            div.innerHTML = savedTests.length === 0 ? '<div class="info-message">No tests saved. Create one!</div>' : '';
            savedTests.forEach(test => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <h3>${test.title}</h3>
                        <p>Created: ${new Date(test.created).toLocaleDateString()}</p>
                    </div>
                    <div class="card-body">
                        <p>Questions: ${test.questions.length} | Duration: ${test.duration} min</p>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="startSavedTest(${test.id})">Start</button>
                            <button class="btn btn-error" onclick="deleteTest(${test.id})">Delete</button>
                        </div>
                    </div>
                `;
                div.appendChild(card);
            });
        }

        function startSavedTest(id) {
            previewTest = savedTests.find(t => t.id === id);
            startTestFromPreview();
        }

        function deleteTest(id) {
            savedTests = savedTests.filter(t => t.id !== id);
            localStorage.setItem('mockTests', JSON.stringify(savedTests));
            loadMyTests();
            showNotification('Test deleted', 'success');
            playClickSound();
        }

        // Results list
        function loadResults() {
            const content = document.getElementById('results-content');
            content.innerHTML = testResults.length === 0 ? '<div class="info-message">No results. Take a test!</div>' : '';
            testResults.slice(-5).reverse().forEach(result => { // Last 5
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <h3>${result.title}</h3>
                        <p>${new Date(result.date).toLocaleString()}</p>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem; text-align: center;">
                            <div><div style="font-size: 1.25rem; color: var(--primary);">${result.score}/${result.totalMarks}</div><div style="color: var(--text-secondary);">Score</div></div>
                            <div><div style="font-size: 1.25rem; color: var(--success);">${result.percentage}%</div><div style="color: var(--text-secondary);">%</div></div>
                        </div>
                        <button class="btn btn-primary" onclick="viewResult(${result.testId}, '${result.date}')">View Details</button>
                    </div>
                `;
                content.appendChild(card);
            });
        }

        function viewResult(id, date) {
            currentResult = testResults.find(r => r.testId === id && r.date === date);
            currentTest = savedTests.find(t => t.id === id);
            if (currentResult && currentTest) {
                userAnswers = currentResult.answers;
                displayResults();
            }
        }

        // Timetable
        function updateSchedule() {
            const daysOrder = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const grouped = {};
            scheduleEntries.forEach(entry => {
                const day = entry.day.toLowerCase();
                if (!grouped[day]) grouped[day] = [];
                grouped[day].push(entry);
            });
            let html = '';
            daysOrder.forEach(day => {
                if (grouped[day]) {
                    const dayName = day.charAt(0).toUpperCase() + day.slice(1);
                    html += `<h4 style="margin: 1rem 0 0.5rem 0; color: var(--primary); font-size: 1rem;">${dayName}</h4>`;
                    grouped[day].sort((a, b) => a.startTime.localeCompare(b.startTime)).forEach(entry => {
                        html += `
                            <div class="schedule-entry card">
                                <div class="schedule-time">${entry.startTime} - ${entry.endTime}</div>
                                <h5 style="margin: 0.25rem 0; color: var(--text-primary);">${entry.subject}</h5>
                                ${entry.notes ? `<p style="margin: 0.25rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">${entry.notes}</p>` : ''}
                                <button class="btn btn-secondary" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="editScheduleEntry(${entry.id})">Edit</button>
                                <button class="btn btn-error" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteScheduleEntry(${entry.id})">Delete</button>
                            </div>
                        `;
                    });
                }
            });
            const listEl = document.getElementById('schedule-list');
            listEl.innerHTML = html || '<div class="info-message">No schedules added yet.</div>';

            // Load from Firebase
            if (window.firebaseAuth.currentUser) {
                window.firebaseFunctions.getDocs(window.firebaseFunctions.collection(window.firebaseDB, 'schedules')).then(snapshot => {
                    snapshot.forEach(doc => {
                        const entry = doc.data();
                        if (!scheduleEntries.find(e => e.id === entry.id)) {
                            scheduleEntries.push(entry);
                            localStorage.setItem('scheduleEntries', JSON.stringify(scheduleEntries));
                        }
                    });
                    updateSchedule(); 
// Refresh
                }).catch(e => console.error('Firebase load error:', e));
            }
        }

        function addScheduleEntry() {
            const day = document.getElementById('schedule-day').value;
            const start = document.getElementById('schedule-start').value;
            const end = document.getElementById('schedule-end').value;
            const subject = document.getElementById('schedule-subject').value.trim();
            const notes = document.getElementById('schedule-notes').value.trim();

            if (!day || !start || !end || !subject || start >= end) return showNotification('Invalid input', 'error');

            const entry = { id: Date.now(), day, startTime: start, endTime: end, subject, notes, created: new Date().toISOString() };
            scheduleEntries.push(entry);
            localStorage.setItem('scheduleEntries', JSON.stringify(scheduleEntries));

            if (window.firebaseAuth.currentUser) {
                window.firebaseFunctions.setDoc(window.firebaseFunctions.doc(window.firebaseDB, 'schedules', `${window.firebaseAuth.currentUser.uid}_${entry.id}`), entry).catch(e => console.error(e));
            }

            document.getElementById('schedule-form').reset();
            showTimetableTab('schedule');
            updateSchedule();
            showNotification('Schedule added!', 'success');
            playSuccessSound();
        }

        function editScheduleEntry(id) {
            const entry = scheduleEntries.find(e => e.id === id);
            if (!entry) return;
            document.getElementById('schedule-day').value = entry.day;
            document.getElementById('schedule-start').value = entry.startTime;
            document.getElementById('schedule-end').value = entry.endTime;
            document.getElementById('schedule-subject').value = entry.subject;
            document.getElementById('schedule-notes').value = entry.notes;
            deleteScheduleEntry(id);
            showTimetableTab('create');
        }

        function deleteScheduleEntry(id) {
            if (confirm('Delete this schedule?')) {
                scheduleEntries = scheduleEntries.filter(e => e.id !== id);
                localStorage.setItem('scheduleEntries', JSON.stringify(scheduleEntries));
                if (window.firebaseAuth.currentUser) {
                    window.firebaseFunctions.doc(window.firebaseDB, 'schedules', `${window.firebaseAuth.currentUser.uid}_${id}`).delete().catch(e => console.error(e));
                }
                updateSchedule();
                showNotification('Schedule deleted', 'success');
            }
        }

        function importHTMLTimetable() {
            const html = document.getElementById('html-timetable').value.trim();
            if (!html) return showNotification('Paste HTML code', 'error');
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tables = doc.querySelectorAll('table');
                let added = 0;
                tables.forEach(table => {
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td, th');
                        if (cells.length >= 4) {
                            const dayStr = cells[0].textContent.trim().toLowerCase();
                            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                            const day = days.find(d => dayStr.includes(d));
                            if (day) {
                                const start = cells[1].textContent.trim();
                                const end = cells[2].textContent.trim();
                                const subject = cells[3].textContent.trim();
                                if (start && end && subject) {
                                    const entry = { id: Date.now() + Math.random(), day, startTime: start, endTime: end, subject, notes: '', created: new Date().toISOString() };
                                    scheduleEntries.push(entry);
                                    added++;
                                }
                            }
                        }
                    });
                });
                if (added > 0) {
                    localStorage.setItem('scheduleEntries', JSON.stringify(scheduleEntries));
                    document.getElementById('html-content').innerHTML = html;
                    document.getElementById('html-preview').style.display = 'block';
                    showTimetableTab('schedule');
                    updateSchedule();
                    showNotification(`${added} entries imported!`, 'success');
                } else {
                    showNotification('No valid entries found', 'warning');
                }
            } catch (e) {
                showNotification('Import error: ' + e.message, 'error');
            }
            playClickSound();
        }

        function clearHTMLTimetable() {
            document.getElementById('html-timetable').value = '';
            document.getElementById('html-content').innerHTML = '';
            document.getElementById('html-preview').style.display = 'none';
            showNotification('Cleared', 'success');
            playClickSound();
        }

        // Notes
        function loadNotes() {
            const list = document.getElementById('notes-list');
            list.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><p>Loading notes...</p></div>';

            if (!navigator.onLine) return list.innerHTML = '<div class="error-message">Offline. Check connection.</div>';

            const q = window.firebaseFunctions.query(window.firebaseFunctions.collection(window.firebaseDB, 'notes'), window.firebaseFunctions.orderBy('uploadedAt', 'desc'));
            window.firebaseFunctions.getDocs(q).then(snapshot => {
                list.innerHTML = snapshot.empty ? '<div class="info-message">No notes available.</div>' : '';
                snapshot.forEach(doc => {
                    const note = doc.data();
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-header">
                            <h3>${note.title}</h3>
                            <p>${new Date(note.uploadedAt).toLocaleString()}</p>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary" onclick="downloadNote('${note.url}', '${note.title.replace(/[^a-z0-9]/gi, '_')}')">Download</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
                document.getElementById('notes-upload').style.display = window.firebaseAuth.currentUser && window.firebaseAuth.currentUser.email === adminEmail ? 'block' : 'none';
            }).catch(e => {
                console.error(e);
                list.innerHTML = '<div class="error-message">Failed to load notes.</div>';
            });
        }

        function downloadNote(url, filename) {
            if (!navigator.onLine) return showNotification('Offline', 'error');
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            showNotification('Downloading...', 'success');
            playSuccessSound();
        }

        function uploadNote() {
            if (!window.firebaseAuth.currentUser || window.firebaseAuth.currentUser.email !== adminEmail) return showNotification('Admin only', 'error');
            const file = document.getElementById('note-file').files[0];
            if (!file) return showNotification('Select file', 'error');

            showLoadingModal();
            const storRef = window.firebaseFunctions.ref(window.firebaseStorage, `notes/${Date.now()}_${file.name}`);
            window.firebaseFunctions.uploadBytes(storRef, file).then(snap => window.firebaseFunctions.getDownloadURL(snap.ref)).then(url => {
                const note = { title: file.name, url, uploadedAt: new Date().toISOString() };
                return window.firebaseFunctions.addDoc(window.firebaseFunctions.collection(window.firebaseDB, 'notes'), note);
            }).then(() => {
                document.getElementById('note-file').value = '';
                loadNotes();
                showNotification('Uploaded!', 'success');
                playSuccessSound();
            }).catch(e => {
                console.error(e);
                showNotification('Upload failed', 'error');
            }).finally(hideLoadingModal);
        }

        // Live Classes
        function loadLiveClasses() {
            const list = document.getElementById('live-list');
            list.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="loading-spinner"></div><p>Loading classes...</p></div>';

            if (!navigator.onLine) return list.innerHTML = '<div class="error-message">Offline.</div>';

            const now = new Date();
            const q = window.firebaseFunctions.query(
                window.firebaseFunctions.collection(window.firebaseDB, 'liveClasses'),
                window.firebaseFunctions.where('date', '>', now.toISOString()),
                window.firebaseFunctions.orderBy('date', 'asc')
            );
            window.firebaseFunctions.getDocs(q).then(snapshot => {
                list.innerHTML = snapshot.empty ? '<div class="info-message">No upcoming classes.</div>' : '';
                snapshot.forEach(doc => {
                    const cls = doc.data();
                    const date = new Date(cls.date);
                    const card = document.createElement('div');
                    card.className = 'card schedule-entry';
                    card.innerHTML = `
                        <div class="card-header">
                            <h3>${cls.title}</h3>
                            <p>${date.toLocaleString()}</p>
                        </div>
                        <div class="card-body">
                            <a href="${cls.link}" target="_blank" class="btn btn-primary">Join Class</a>
                        </div>
                    `;
                    list.appendChild(card);
                });
                // Past classes
                const pastQ = window.firebaseFunctions.query(window.firebaseFunctions.collection(window.firebaseDB, 'liveClasses'), window.firebaseFunctions.orderBy('date', 'desc'));
                window.firebaseFunctions.getDocs(pastQ).then(pastSnap => {
                    if (!pastSnap.empty) {
                        list.innerHTML += '<h4 style="margin: 2rem 0 1rem 0; color: var(--text-secondary);">Past Classes</h4>';
                        pastSnap.forEach(doc => {
                            const cls = doc.data();
                            if (new Date(cls.date) < now) {
                                const card = document.createElement('div');
                                card.className = 'card';
                                card.innerHTML = `
                                    <div class="card-header">
                                        <h3>${cls.title}</h3>
                                        <p>${new Date(cls.date).toLocaleString()}</p>
                                    </div>
                                    <div class="card-body">
                                        <a href="${cls.link}" target="_blank" class="btn btn-secondary">View Recording</a>
                                    </div>
                                `;
                                list.appendChild(card);
                            }
                        });
                    }
                    document.getElementById('live-create').style.display = window.firebaseAuth.currentUser && window.firebaseAuth.currentUser.email === adminEmail ? 'block' : 'none';
                });
            }).catch(e => {
                console.error(e);
                list.innerHTML = '<div class="error-message">Failed to load.</div>';
            });
        }

        function createLiveClass() {
            if (!window.firebaseAuth.currentUser || window.firebaseAuth.currentUser.email !== adminEmail) return showNotification('Admin only', 'error');
            const title = document.getElementById('live-title').value.trim();
            const date = document.getElementById('live-date').value;
            const link = document.getElementById('live-link').value.trim();
            if (!title || !date || !link || !link.match(/^https?:\/\//)) return showNotification('Invalid input', 'error');

            showLoadingModal();
            const cls = { title, date, link, created: new Date().toISOString() };
            window.firebaseFunctions.addDoc(window.firebaseFunctions.collection(window.firebaseDB, 'liveClasses'), cls).then(() => {
                document.getElementById('live-title').value = '';
                document.getElementById('live-date').value = '';
                document.getElementById('live-link').value = '';
                loadLiveClasses();
                showNotification('Class created!', 'success');
                playSuccessSound();
            }).catch(e => {
                console.error(e);
                showNotification('Failed to create', 'error');
            }).finally(hideLoadingModal);
        }

        // Utility
        function showNotification(msg, type = 'info') {
            const notif = document.getElementById('notification');
            const text = document.getElementById('notification-text');
            text.textContent = msg;
            notif.className = `notification show ${type}`;
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        function showLoadingModal() {
            document.getElementById('loading-modal').classList.add('show');
        }

        function hideLoadingModal() {
            document.getElementById('loading-modal').classList.remove('show');
        }

        function toggleSound() {
            soundEnabled = document.getElementById('sound-enabled').checked;
            localStorage.setItem('soundEnabled', soundEnabled);
            showNotification(`Sounds ${soundEnabled ? 'on' : 'off'}`, 'success');
        }

        function toggleNotifications() {
            const enabled = document.getElementById('notifications-enabled').checked;
            showNotification(`Notifications ${enabled ? 'on' : 'off'}`, 'success');
        }

        function clearAllData() {
            if (confirm('Clear all data? Irreversible!')) {
                localStorage.clear();
                savedTests = []; testResults = []; scheduleEntries = [];
                userProfile = { name: 'Guest User', email: '', bio: 'Quiz enthusiast ready to learn!', profilePicture: null, memberSince: new Date().toISOString() };
                updateProfileDisplay();
                showScreen('dashboard');
                showNotification('Data cleared', 'success');
                playSuccessSound();
                if (window.firebaseAuth.currentUser) window.firebaseFunctions.signOut(window.firebaseAuth);
            }
        }

        // PWA
        function setupPWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js').then(reg => console.log('SW registered')).catch(err => console.error('SW error', err));
            }
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('install-btn').style.display = 'block';
            });
            document.getElementById('install-btn').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(() => deferredPrompt = null);
                    document.getElementById('install-btn').style.display = 'none';
                }
            });
        }

        // Auth
        function login() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            if (!email || !password) return showNotification('Enter email and password', 'error');
            showLoadingModal();
            window.firebaseFunctions.signInWithEmailAndPassword(window.firebaseAuth, email, password).then(() => {
                hideLoadingModal();
                document.getElementById('auth-form').reset();
                showScreen('dashboard');
            }).catch(e => {
                hideLoadingModal();
                showNotification('Login failed: ' + e.message, 'error');
            });
        }

        function signup() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            if (!email || password.length < 6) return showNotification('Valid email and password (6+ chars)', 'error');
            showLoadingModal();
            window.firebaseFunctions.createUserWithEmailAndPassword(window.firebaseAuth, email, password).then(cred => {
                return window.firebaseFunctions.sendEmailVerification(cred.user);
            }).then(() => {
                hideLoadingModal();
                document.getElementById('auth-form').reset();
                showNotification('Account created! Verify email.', 'success');
                showScreen('dashboard');
            }).catch(e => {
                hideLoadingModal();
                showNotification('Signup failed: ' + e.message, 'error');
            });
        }

        function logout() {
            showLoadingModal();
            window.firebaseFunctions.signOut(window.firebaseAuth).then(() => {
                hideLoadingModal();
                userProfile.email = '';
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                updateProfileDisplay();
                showScreen('dashboard');
                showNotification('Logged out', 'success');
            }).catch(e => {
                hideLoadingModal();
                showNotification('Logout failed', 'error');
            });
        }

        // Close modals on outside click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) closeModal();
        });

        // Close menu on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav-left')) closeMenu();
        });
    </script>
</body>
</html>