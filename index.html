<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Test Pro</title>
    <meta name="screen-orientation" content="auto">
    
    <!-- Firebase SDKs v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, orderBy, query } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCs2Ab_fTU18xj8o0qXuzIrphMT7OERNYY",
            authDomain: "practicpro-mock-0786.firebaseapp.com",
            projectId: "practicpro-mock-0786",
            storageBucket: "practicpro-mock-0786.appspot.com",
            messagingSenderId: "457425256741",
            appId: "1:457425256741:web:0807a6c133c8fb1bc51acc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Make Firebase services available globally
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.firebaseStorage = storage;
        window.firebaseFunctions = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            sendEmailVerification,
            collection,
            doc,
            setDoc,
            getDoc,
            getDocs,
            addDoc,
            orderBy,
            query,
            ref,
            uploadBytes,
            getDownloadURL
        };
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --border: #e2e8f0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1e293b;
            --bg-secondary: #0f172a;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border: #334155;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        .navbar {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #818cf8);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .profile-toggle:hover {
            transform: scale(1.1);
        }

        .profile-toggle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            position: relative;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .card-header h2 {
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .card-body {
            padding: 1.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-primary);
            border-color: var(--primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        .btn-error:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-1px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            min-height: 200px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .feature-card {
            text-align: center;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .test-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            height: calc(100vh - 150px);
            min-height: 600px;
        }

        .question-sidebar {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border);
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .timer-display {
            background: linear-gradient(135deg, var(--success), #34d399);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            margin-bottom: 1.5rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .timer-display.warning {
            background: linear-gradient(135deg, var(--warning), #fbbf24);
            animation: pulse 1s infinite;
        }

        .timer-display.critical {
            background: linear-gradient(135deg, var(--error), #f87171);
            animation: shake 0.5s infinite;
        }

        .question-timer {
            background: linear-gradient(135deg, var(--primary), #818cf8);
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .question-timer.warning {
            background: linear-gradient(135deg, var(--warning), #fbbf24);
        }

        .question-timer.critical {
            background: linear-gradient(135deg, var(--error), #f87171);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        .question-nav {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .question-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .question-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 49%, rgba(255,255,255,0.3) 50%, transparent 51%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .question-btn:hover::before {
            transform: translateX(100%);
        }

        .question-btn.unvisited {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .question-btn.visited {
            background: #f87171;
            color: white;
        }

        .question-btn.answered {
            background: #34d399;
            color: white;
        }

        .question-btn.marked {
            background: #a78bfa;
            color: white;
        }

        .question-btn.locked {
            background: #6b7280;
            color: white;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .question-btn.current {
            box-shadow: 0 0 0 3px var(--primary);
            z-index: 10;
        }

        .question-content {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
        }

        .question-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(129, 140, 248, 0.05));
        }

        .question-body {
            padding: 2rem;
            flex: 1;
            overflow-y: auto;
        }

        .question-text {
            font-size: 1.125rem;
            margin-bottom: 2rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .options-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .option-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 49%, rgba(99, 102, 241, 0.1) 50%, transparent 51%);
            transform: translateX(-100%);
            transition: transform 0.3s;
        }

        .option-item:hover::before {
            transform: translateX(100%);
        }

        .option-item:hover:not(.disabled) {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .option-item.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            transform: translateX(5px);
        }

        .option-item.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .option-item.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .option-item.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .option-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .option-item.selected .option-radio {
            border-color: var(--primary);
            background: var(--primary);
        }

        .option-item.selected .option-radio::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .question-controls {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
            background: var(--bg-secondary);
        }

        .control-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .legend {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 0.25rem;
            flex-shrink: 0;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); }
            to { transform: translateY(0); }
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            color: var(--error);
            text-align: center;
        }

        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            color: var(--success);
            text-align: center;
        }

        .info-message {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            color: var(--primary);
            text-align: center;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .nav-menu {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
            }

            .nav-link {
                text-align: center;
                width: 100%;
            }

            .test-layout {
                grid-template-columns: 1fr;
                height: auto;
                gap: 1rem;
            }

            .question-sidebar {
                order: 2;
                position: sticky;
                bottom: 0;
                z-index: 50;
                max-height: 200px;
            }

            .question-content {
                order: 1;
                min-height: 60vh;
            }

            .container {
                padding: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .control-group {
                flex-direction: column;
                width: 100%;
            }

            .question-controls {
                flex-direction: column;
                gap: 1rem;
            }

            .modal-content {
                width: 95%;
                margin: 1rem;
            }
        }

        @media (orientation: landscape) and (max-width: 1024px) {
            .test-layout {
                grid-template-columns: 250px 1fr;
            }

            .question-sidebar {
                padding: 1rem;
            }
        }
    </style>
</head>
<body data-theme="light">
    <nav class="navbar">
        <div class="nav-left">
            <div class="profile-toggle" onclick="showScreen('profile')" id="profile-toggle">
                <span id="profile-initial">G</span>
                <img id="profile-image" style="display: none;" alt="Profile" />
            </div>
            <div class="nav-brand">üß† Mock Test Pro</div>
        </div>
        <div class="nav-menu">
            <a href="#" class="nav-link active" onclick="showScreen('dashboard')">Dashboard</a>
            <a href="#" class="nav-link" onclick="showScreen('my-tests')">My Tests</a>
            <a href="#" class="nav-link" onclick="showScreen('results')">Results</a>
            <a href="#" class="nav-link" onclick="showScreen('timetable')">Timetable</a>
            <a href="#" class="nav-link" onclick="showScreen('settings')">Settings</a>
            <a href="#" class="nav-link" onclick="showScreen('notes')">Notes</a>
            <a href="#" class="nav-link" onclick="showScreen('live-classes')">Live Classes</a>
            <a href="#" class="nav-link" onclick="showScreen('auth')" id="auth-nav">Login</a>
            <a href="#" class="nav-link" onclick="logout()" id="logout-nav" style="display:none;">Logout</a>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">üåô</span>
            </button>
        </div>
    </nav>

    <!-- Dashboard Screen -->
    <div class="screen active" id="dashboard-screen">
        <div class="container">
            <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 3rem;">
                <div id="dashboard-avatar" style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #818cf8); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; position: relative; overflow: hidden; border: 3px solid var(--border);">
                    <span id="dashboard-initial">G</span>
                    <img id="dashboard-image" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none;" alt="Profile Picture" />
                </div>
                <div>
                    <h1 style="margin: 0;">Welcome back, <span id="dashboard-name">Guest User</span>!</h1>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0 0 0;" id="dashboard-bio">Quiz enthusiast ready to learn!</p>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <div class="card feature-card">
                    <div class="feature-icon">üìÑ</div>
                    <h3>Create New Test</h3>
                    <p>Upload questions via JSON and start your mock test</p>
                    <button class="btn btn-primary" onclick="showScreen('upload')">Get Started</button>
                </div>
                
                <div class="card feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>View Results</h3>
                    <p>Analyze your performance and track progress</p>
                    <button class="btn btn-secondary" onclick="showScreen('results')">View Results</button>
                </div>
                
                <div class="card feature-card">
                    <div class="feature-icon">üìö</div>
                    <h3>My Tests</h3>
                    <p>Access your saved tests and retake them</p>
                    <button class="btn btn-secondary" onclick="showScreen('my-tests')">Browse Tests</button>
                </div>

                <div class="card feature-card">
                    <div class="feature-icon">üìÖ</div>
                    <h3>Timetable</h3>
                    <p>Manage your study schedule and plan</p>
                    <button class="btn btn-secondary" onclick="showScreen('timetable')">View Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Screen -->
    <div class="screen" id="upload-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Upload Test Questions</h2>
                    <p>Create your custom mock test with JSON format questions</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">üìù JSON Format Instructions</label>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Use this JSON format to prepare your questions. You can also ask any AI tool to generate questions directly in this format.</p>
                        
                        <div class="copy-container">
                            <div class="json-example" id="json-example">[
  {
    "question": "What is the capital of France?",
    "options": ["London", "Berlin", "Paris", "Madrid"],
    "correct": 2,
    "explanation": "Paris is the capital and largest city of France.",
    "marks": 1
  },
  {
    "question": "Which planet is closest to the Sun?",
    "options": ["Venus", "Mercury", "Earth", "Mars"],
    "correct": 1,
    "explanation": "Mercury is the smallest planet and closest to the Sun.",
    "marks": 2
  }
]</div>
                            <button class="copy-btn" onclick="copyJsonExample()">üìã Copy Format</button>
                        </div>
                        
                        <button class="btn btn-secondary" style="margin-top: 1rem;" onclick="pasteFromClipboard()">üì• Paste from Clipboard</button>
                    </div>

                    <form id="upload-form">
                        <div class="form-group">
                            <label class="form-label" for="test-title">Test Title</label>
                            <input type="text" id="test-title" class="form-input" required>
                        </div>
                        
                        <div class="test-config">
                            <h4>Test Configuration</h4>
                            <div class="config-row">
                                <label for="test-duration">Duration (minutes):</label>
                                <input type="number" id="test-duration" value="60" min="1" required>
                            </div>
                            <div class="config-row">
                                <label for="default-marks">Default marks per question:</label>
                                <input type="number" id="default-marks" value="1" min="0" step="0.25">
                            </div>
                            <div class="config-row">
                                <label for="negative-marks">Negative marks:</label>
                                <input type="number" id="negative-marks" value="0" min="0" step="0.25">
                            </div>
                            <div class="config-row">
                                <label for="per-question-timer">Enable per-question timer:</label>
                                <input type="checkbox" id="per-question-timer">
                            </div>
                            <div class="config-row" id="question-time-row" style="display: none;">
                                <label for="question-time">Time per question (seconds):</label>
                                <input type="number" id="question-time" value="60" min="10">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="questions-json">Questions JSON</label>
                            <textarea id="questions-json" class="form-input form-textarea" 
                                placeholder='Paste your questions JSON here...' 
                                required></textarea>
                        </div>
                        
                        <div>
                            <button type="button" class="btn btn-primary" onclick="loadQuestions()">Load Questions</button>
                            <button type="button" class="btn btn-secondary" onclick="showScreen('dashboard')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Preview Screen -->
    <div class="screen" id="preview-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2 id="preview-title">Test Preview</h2>
                    <p>Review your test settings before starting</p>
                </div>
                <div class="card-body">
                    <div id="test-info" class="test-config">
                        <!-- Test info will be populated here -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn btn-primary animate-bounce" onclick="startTestFromPreview()" style="font-size: 1.2rem; padding: 1rem 2rem;">üöÄ Start Test</button>
                        <button class="btn btn-secondary" onclick="showScreen('upload')">‚Üê Back to Edit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Screen -->
    <div class="screen" id="test-screen">
        <div class="container">
            <div class="test-layout">
                <div class="question-sidebar">
                    <div class="timer-display" id="timer-display">
                        <div>Time Remaining</div>
                        <div id="timer-text">60:00</div>
                    </div>
                    
                    <div class="question-timer" id="question-timer" style="display: none;">
                        <div>Question Time</div>
                        <div id="question-timer-text">60</div>
                    </div>
                    
                    <h3>Questions</h3>
                    <div class="question-nav" id="question-nav"></div>
                    
                    <div class="legend">
                        <h4>Legend</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--bg-secondary); border: 1px solid var(--border);"></div>
                                <span>Unvisited</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f87171;"></div>
                                <span>Visited</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #34d399;"></div>
                                <span>Answered</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #a78bfa;"></div>
                                <span>Marked</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #6b7280;"></div>
                                <span>Locked</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="question-content">
                    <div class="question-header">
                        <h2 id="question-title">Question 1</h2>
                        <div class="control-group">
                            <button class="btn btn-warning" onclick="markForReview()">Mark Review</button>
                            <button class="btn btn-secondary" onclick="clearResponse()">Clear</button>
                        </div>
                    </div>
                    
                    <div class="question-body">
                        <div class="question-text" id="question-text">Loading...</div>
                        <ul class="options-list" id="options-list"></ul>
                    </div>
                    
                    <div class="question-controls">
                        <div class="control-group">
                            <button class="btn btn-secondary" id="prev-btn" onclick="previousQuestion()" disabled>‚Üê Previous</button>
                            <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()">Next ‚Üí</button>
                        </div>
                        <button class="btn btn-error" onclick="showSubmitModal()">Submit Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div class="screen" id="results-screen">
        <div class="container">
            <div id="results-content"></div>
        </div>
    </div>

    <!-- Review Screen -->
    <div class="screen" id="review-screen">
        <div class="container">
            <div class="test-layout">
                <div class="question-sidebar">
                    <div style="background: linear-gradient(135deg, var(--primary), #818cf8); color: white; padding: 1rem; border-radius: 0.75rem; text-align: center; margin-bottom: 1.5rem;">
                        <div>Review Mode</div>
                        <div style="font-size: 0.875rem;">Solutions & Explanations</div>
                    </div>
                    
                    <h3>Questions</h3>
                    <div class="question-nav" id="review-question-nav"></div>
                    
                    <div style="margin-top: 1.5rem;">
                        <button class="btn btn-success" onclick="downloadPDF()" style="width: 100%; margin-bottom: 1rem;">Download PDF</button>
                        <button class="btn btn-secondary" onclick="showScreen('dashboard')" style="width: 100%;">Dashboard</button>
                    </div>
                </div>

                <div class="question-content">
                    <div class="question-header">
                        <h2 id="review-question-title">Question 1</h2>
                        <div id="review-status" class="review-status">CORRECT</div>
                    </div>
                    
                    <div class="question-body">
                        <div class="question-text" id="review-question-text">Loading...</div>
                        <ul class="options-list" id="review-options-list"></ul>
                        <div id="explanation" class="explanation" style="display: none;">
                            <h4>Explanation</h4>
                            <div id="explanation-text"></div>
                        </div>
                    </div>
                    
                    <div class="question-controls">
                        <div class="control-group">
                            <button class="btn btn-secondary" id="review-prev-btn" onclick="prevReview()" disabled>‚Üê Previous</button>
                            <button class="btn btn-primary" id="review-next-btn" onclick="nextReview()">Next ‚Üí</button>
                        </div>
                        <button class="btn btn-warning" onclick="retakeTest()">Retake Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Tests Screen -->
    <div class="screen" id="my-tests-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>My Tests</h2>
                    <p>Access and manage your saved tests</p>
                </div>
                <div class="card-body">
                    <div id="saved-tests">
                        <div style="text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 1rem;">Loading your tests...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div class="screen" id="auth-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>üîê Login / Signup</h2>
                    <p>Access your account to continue</p>
                </div>
                <div class="card-body">
                    <div id="auth-loading" style="display: none; text-align: center; margin: 2rem 0;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 1rem;">Processing...</p>
                    </div>
                    
                    <form id="auth-form">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="auth-email" class="form-input" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" id="auth-password" class="form-input" placeholder="Enter password" required minlength="6">
                        </div>
                        <div style="display:flex; gap:1rem; margin-top:1rem; flex-wrap: wrap;">
                            <button type="button" class="btn btn-primary" onclick="login()">Login</button>
                            <button type="button" class="btn btn-secondary" onclick="signup()">Signup</button>
                        </div>
                    </form>
                    
                    <div id="auth-message" style="margin-top:1rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Screen -->
    <div class="screen" id="profile-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>User Profile</h2>
                    <p>Manage your profile information</p>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 2rem;">
                        <div style="position: relative; margin-bottom: 1rem;">
                            <div id="profile-avatar" style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #818cf8); display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; position: relative; overflow: hidden; cursor: pointer; border: 4px solid var(--border);" onclick="document.getElementById('profile-picture-input').click()">
                                <span id="profile-initial-display">G</span>
                                <img id="profile-image-display" style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none;" alt="Profile Picture" />
                                <div style="position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 3px solid var(--bg-primary); cursor: pointer;">
                                    üì∑
                                </div>
                            </div>
                            <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                        </div>
                        <button class="btn btn-secondary" onclick="removeProfilePicture()">Remove Picture</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="profile-name">Full Name</label>
                        <input type="text" id="profile-name" class="form-input" placeholder="Enter your full name" value="Guest User">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="profile-email">Email</label>
                        <input type="email" id="profile-email" class="form-input" placeholder="Enter your email" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="profile-bio">Bio</label>
                        <textarea id="profile-bio" class="form-input" placeholder="Tell us about yourself..." rows="3" style="resize: vertical;">Quiz enthusiast ready to learn!</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Member Since</label>
                        <p style="margin: 0; color: var(--text-secondary); padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;" id="member-since">Today</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin: 2rem 0;">
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--primary);" id="tests-taken">0</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">Tests Taken</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--success);" id="avg-score">0%</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">Average Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" style="color: var(--warning);" id="best-score">0%</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">Best Score</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveProfile()">üíæ Save Profile</button>
                        <button class="btn btn-secondary" onclick="showScreen('dashboard')">‚Üê Back to Dashboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timetable Screen -->
    <div class="screen" id="timetable-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>My Timetable</h2>
                    <p>Manage your study schedule</p>
                </div>
                <div class="card-body">
                    <div class="timetable-nav">
                        <button class="timetable-tab active" onclick="showTimetableTab('today')">Today's Schedule</button>
                        <button class="timetable-tab" onclick="showTimetableTab('create')">Create Entry</button>
                        <button class="timetable-tab" onclick="showTimetableTab('import')">Import HTML</button>
                    </div>

                    <div id="today-tab" class="timetable-container">
                        <h3 id="today-date"></h3>
                        <div id="today-schedule">
                            <div style="text-align: center; padding: 2rem;">
                                <div class="loading-spinner"></div>
                                <p style="margin-top: 1rem;">Loading today's schedule...</p>
                            </div>
                        </div>
                    </div>

                    <div id="create-tab" class="timetable-container" style="display: none;">
                        <h3>Create Schedule Entry</h3>
                        <form id="schedule-form">
                            <div class="form-group">
                                <label class="form-label">Day</label>
                                <select id="schedule-day" class="form-input" required>
                                    <option value="monday">Monday</option>
                                    <option value="tuesday">Tuesday</option>
                                    <option value="wednesday">Wednesday</option>
                                    <option value="thursday">Thursday</option>
                                    <option value="friday">Friday</option>
                                    <option value="saturday">Saturday</option>
                                    <option value="sunday">Sunday</option>
                                </select>
                            </div>
                            <div class="config-row">
                                <label>Start Time:</label>
                                <input type="time" id="schedule-start" class="form-input" required>
                                <label>End Time:</label>
                                <input type="time" id="schedule-end" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subject/Activity</label>
                                <input type="text" id="schedule-subject" class="form-input" placeholder="e.g., Mathematics, Study Session" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes (Optional)</label>
                                <textarea id="schedule-notes" class="form-input" placeholder="Additional details..." rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Entry</button>
                        </form>
                    </div>

                    <div id="import-tab" class="timetable-container" style="display: none;">
                        <h3>Import HTML Timetable</h3>
                        <p>Paste your complete HTML timetable code below. It will be displayed seamlessly within the app.</p>
                        <div class="form-group">
                            <label class="form-label">HTML Code</label>
                            <textarea id="html-timetable" class="form-input" placeholder="Paste your HTML timetable code here..." rows="10"></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="importHTMLTimetable()">Import Timetable</button>
                            <button class="btn btn-secondary" onclick="clearHTMLTimetable()">Clear</button>
                        </div>
                        
                        <div id="html-preview" class="timetable-container" style="display: none; margin-top: 1rem; border: 2px dashed var(--border);">
                            <h4>Preview:</h4>
                            <div id="html-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Settings Screen -->
    <div class="screen" id="settings-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Settings</h2>
                    <p>Customize your experience</p>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="sound-enabled" checked onchange="toggleSound()"> 
                            Enable sound effects
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="notifications-enabled" checked onchange="toggleNotifications()"> 
                            Show notifications
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="auto-submit" checked> 
                            Auto submit when time expires
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="auto-rotate" checked onchange="toggleAutoRotate()"> 
                            Enable automatic screen rotation
                        </label>
                    </div>
                    
                    <div class="form-group" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                        <h4 style="color: var(--error); margin-bottom: 1rem;">Danger Zone</h4>
                        <button class="btn btn-error" onclick="clearAllData()">Clear All Data</button>
                        <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">This will delete all your tests, results, and settings. This action cannot be undone.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notes Screen -->
    <div class="screen" id="notes-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Study Notes</h2>
                    <p>Download study notes uploaded by admins</p>
                </div>
                <div class="card-body">
                    <div id="notes-list">
                        <div style="text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 1rem;">Loading notes...</p>
                        </div>
                    </div>
                    <div id="notes-upload" style="margin-top:1rem; display:none; padding: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary);">
                        <h4>Upload New Note (Admin Only)</h4>
                        <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem; flex-wrap: wrap;">
                            <input type="file" id="note-file" class="form-input" style="flex: 1; min-width: 200px;" accept=".pdf,.doc,.docx,.txt,.ppt,.pptx" />
                            <button class="btn btn-primary" onclick="uploadNote()">Upload Note</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Classes Screen -->
    <div class="screen" id="live-classes-screen">
        <div class="container">
            <div class="card">
                <div class="card-header">
                    <h2>Live Classes</h2>
                    <p>Join upcoming live sessions</p>
                </div>
                <div class="card-body">
                    <div id="live-list">
                        <div style="text-align: center; padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <p style="margin-top: 1rem;">Loading live classes...</p>
                        </div>
                    </div>
                    <div id="live-create" style="margin-top:1rem; display:none; padding: 1rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--bg-secondary);">
                        <h4>Create Live Class (Admin Only)</h4>
                        <div class="form-group">
                            <input type="text" id="live-title" placeholder="Class Title" class="form-input" />
                        </div>
                        <div class="form-group">
                            <input type="datetime-local" id="live-date" class="form-input" />
                        </div>
                        <div class="form-group">
                            <input type="url" id="live-link" placeholder="Meeting Link (e.g., Zoom, Meet)" class="form-input" />
                        </div>
                        <button class="btn btn-primary" onclick="createLiveClass()">Create Live Class</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Modal -->
    <div class="modal" id="submit-modal">
        <div class="modal-content">
            <h3>Submit Test?</h3>
            <p>Are you sure you want to submit? You cannot change answers after submission.</p>
            <div id="submit-summary"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-error" onclick="submitTest()">Submit</button>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal" id="loading-modal">
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <p style="margin-top: 1rem; text-align: center;">Loading...</p>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div id="notification-text"></div>
    </div>

    <!-- Desktop Mode Toggle -->
    <button class="desktop-toggle" id="desktop-toggle" onclick="toggleDesktopMode()" title="Toggle Fullscreen Mode">
        <span id="desktop-icon">üíª</span>
    </button>

    <script>
        // Global variables
        let currentTest = null;
        let currentQuestion = 0;
        let userAnswers = {};
        let questionStatus = {};
        let lockedQuestions = new Set();
        let testTimer = null;
        let questionTimer = null;
        let timeRemaining = 0;
        let questionTimeRemaining = 0;
        let savedTests = [];
        let testResults = [];
        let currentResult = null;
        let soundEnabled = true;
        let previewTest = null;
        let scheduleEntries = [];

        // User profile data
        let userProfile = {
            name: 'Guest User',
            email: '',
            bio: 'Quiz enthusiast ready to learn!',
            profilePicture: null,
            memberSince: new Date().toISOString()
        };

        // Screen navigation
        function showScreen(screenId) {
            playClickSound();
            
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show the selected screen
            const targetScreen = document.getElementById(screenId + '-screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
            
            // Update navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Find and activate the matching nav link
            const navLinks = document.querySelectorAll('.nav-link');
            for (let link of navLinks) {
                if (link.textContent.toLowerCase().includes(screenId.split('-')[0]) || 
                    (screenId === 'dashboard' && link.textContent.toLowerCase().includes('dashboard')) ||
                    (screenId === 'my-tests' && link.textContent.toLowerCase().includes('tests')) ||
                    (screenId === 'results' && link.textContent.toLowerCase().includes('results')) ||
                    (screenId === 'profile' && link.textContent.toLowerCase().includes('profile')) ||
                    (screenId === 'timetable' && link.textContent.toLowerCase().includes('timetable')) ||
                    (screenId === 'settings' && link.textContent.toLowerCase().includes('settings'))) {
                    link.classList.add('active');
                    break;
                }
            }

            // Load content for specific screens
            if (screenId === 'my-tests') loadMyTests();
            if (screenId === 'results') loadResults();
            if (screenId === 'timetable') updateTodaySchedule();
            if (screenId === 'notes') loadNotes();
            if (screenId === 'live-classes') loadLiveClasses();
        }

        // Timetable tab navigation
        function showTimetableTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.timetable-container').forEach(container => {
                container.style.display = 'none';
            });
            
            // Show the selected tab
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) {
                targetTab.style.display = 'block';
            }
            
            // Update tab buttons
            document.querySelectorAll('.timetable-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            event.target.classList.add('active');
        }

        // Theme toggle
        function toggleTheme() {
            playClickSound();
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.setAttribute('data-theme', 'light');
                icon.textContent = 'üåô';
            } else {
                body.setAttribute('data-theme', 'dark');
                icon.textContent = '‚òÄÔ∏è';
            }
        }

        // Sound functions
        function playClickSound() {
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {}
        }

        function playSuccessSound() {
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 600;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {}
        }

        // Copy JSON example function
        function copyJsonExample() {
            const jsonText = document.getElementById('json-example').textContent;
            navigator.clipboard.writeText(jsonText).then(() => {
                showNotification('JSON format copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy. Please copy manually.', 'error');
            });
        }

        // Paste from clipboard function
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('questions-json').value = text;
                showNotification('Content pasted from clipboard!', 'success');
            } catch (err) {
                showNotification('Failed to paste from clipboard. Please paste manually.', 'error');
            }
        }

        // Auto rotation toggle
        function toggleAutoRotate() {
            const enabled = document.getElementById('auto-rotate').checked;
            localStorage.setItem('autoRotate', enabled);
            
            if (enabled) {
                try {
                    screen.orientation.unlock();
                    showNotification('Auto-rotation enabled', 'success');
                } catch (e) {
                    showNotification('Auto-rotation not supported on this device', 'warning');
                }
            } else {
                showNotification('Auto-rotation disabled', 'success');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            setupFormHandlers();
            showNotification('Welcome to Mock Test Pro!', 'success');
            updateTodayDate();
            
            // Handle per-question timer toggle
            document.getElementById('per-question-timer').addEventListener('change', function() {
                document.getElementById('question-time-row').style.display = 
                    this.checked ? 'flex' : 'none';
            });
            
            // Set auto-rotate based on saved preference
            const autoRotate = localStorage.getItem('autoRotate') !== 'false';
            document.getElementById('auto-rotate').checked = autoRotate;
            if (autoRotate) {
                try {
                    screen.orientation.unlock();
                } catch (e) {}
            }

            // Check online status on load
            if (!navigator.onLine) {
                showNotification('You are offline. Please check your connection.', 'error');
            }

            // Add online/offline event listeners
            window.addEventListener('online', () => {
                showNotification('You are back online!', 'success');
            });
            window.addEventListener('offline', () => {
                showNotification('You are offline. Please check your connection.', 'error');
            });
        });

        function loadSavedData() {
            const defaultProfile = {
                name: 'Guest User',
                email: '',
                bio: 'Quiz enthusiast ready to learn!',
                profilePicture: null,
                memberSince: new Date().toISOString()
            };
            
            try {
                savedTests = JSON.parse(localStorage.getItem('mockTests') || '[]');
                testResults = JSON.parse(localStorage.getItem('testResults') || '[]');
                userProfile = JSON.parse(localStorage.getItem('userProfile') || JSON.stringify(defaultProfile));
                scheduleEntries = JSON.parse(localStorage.getItem('scheduleEntries') || '[]');
                soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
                
                document.getElementById('sound-enabled').checked = soundEnabled;
                updateProfileDisplay();
                updateTodaySchedule();
            } catch (e) {
                console.error('Error loading saved data:', e);
                // Reset to defaults
                savedTests = [];
                testResults = [];
                userProfile = defaultProfile;
                scheduleEntries = [];
                soundEnabled = true;
            }
        }

        function updateProfileDisplay() {
            document.getElementById('profile-name').value = userProfile.name;
            document.getElementById('profile-email').value = userProfile.email || '';
            document.getElementById('profile-bio').value = userProfile.bio;
            document.getElementById('member-since').textContent = new Date(userProfile.memberSince).toLocaleDateString();
            
            document.getElementById('dashboard-name').textContent = userProfile.name;
            document.getElementById('dashboard-bio').textContent = userProfile.bio;
            
            const profileElements = [
                { toggle: 'profile-toggle', initial: 'profile-initial', image: 'profile-image' },
                { initial: 'profile-initial', image: 'profile-image' },
                { initial: 'dashboard-initial', image: 'dashboard-image' }
            ];
            
            profileElements.forEach(({ toggle, initial, image }) => {
                const toggleEl = toggle ? document.getElementById(toggle) : null;
                const initialEl = document.getElementById(initial);
                const imageEl = document.getElementById(image);
                
                if (initialEl && imageEl) {
                    if (userProfile.profilePicture) {
                        imageEl.src = userProfile.profilePicture;
                        imageEl.style.display = 'block';
                        initialEl.style.display = 'none';
                    } else {
                        imageEl.style.display = 'none';
                        initialEl.style.display = 'flex';
                        initialEl.textContent = userProfile.name.charAt(0).toUpperCase();
                    }
                }
            });
            
            const testsTaken = testResults.length;
            const avgScore = testsTaken > 0 ? Math.round(testResults.reduce((sum, r) => sum + r.percentage, 0) / testsTaken) : 0;
            const bestScore = testsTaken > 0 ? Math.max(...testResults.map(r => r.percentage)) : 0;
            
            const testsTakenEl = document.getElementById('tests-taken');
            const avgScoreEl = document.getElementById('avg-score');
            const bestScoreEl = document.getElementById('best-score');
            
            if (testsTakenEl) testsTakenEl.textContent = testsTaken;
            if (avgScoreEl) avgScoreEl.textContent = avgScore + '%';
            if (bestScoreEl) bestScoreEl.textContent = bestScore + '%';
        }

        function saveProfile() {
            playClickSound();
            
            const name = document.getElementById('profile-name').value.trim();
            const email = document.getElementById('profile-email').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();
            
            if (!name) {
                showNotification('Please enter your name', 'error');
                return;
            }
            
            userProfile.name = name;
            userProfile.email = email;
            userProfile.bio = bio || 'Quiz enthusiast ready to learn!';
            
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateProfileDisplay();
            
            playSuccessSound();
            showNotification('Profile saved successfully!', 'success');
        }

        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Please select a valid image file', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Image size should be less than 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                userProfile.profilePicture = e.target.result;
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                updateProfileDisplay();
                playSuccessSound();
                showNotification('Profile picture updated!', 'success');
            };
            reader.readAsDataURL(file);
        }

        function removeProfilePicture() {
            playClickSound();
            userProfile.profilePicture = null;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            updateProfileDisplay();
            showNotification('Profile picture removed', 'success');
        }

        function setupFormHandlers() {
            const profilePictureInput = document.getElementById('profile-picture-input');
            if (profilePictureInput) {
                profilePictureInput.addEventListener('change', handleProfilePictureUpload);
            }
            
            const scheduleForm = document.getElementById('schedule-form');
            if (scheduleForm) {
                scheduleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addScheduleEntry();
                });
            }
        }

        function loadQuestions() {
            const title = document.getElementById('test-title').value.trim();
            const duration = parseInt(document.getElementById('test-duration').value);
            const jsonText = document.getElementById('questions-json').value.trim();
            const defaultMarks = parseFloat(document.getElementById('default-marks').value);
            const negativeMarks = parseFloat(document.getElementById('negative-marks').value);
            const perQuestionTimer = document.getElementById('per-question-timer').checked;
            const questionTime = parseInt(document.getElementById('question-time').value);

            if (!title || !duration || !jsonText) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            try {
                const questions = JSON.parse(jsonText);
                
                if (!Array.isArray(questions) || questions.length === 0) {
                    throw new Error('Invalid questions format - must be an array');
                }

                for (let i = 0; i < questions.length; i++) {
                    const q = questions[i];
                    if (!q.question || !Array.isArray(q.options) || typeof q.correct !== 'number') {
                        throw new Error(`Invalid question at index ${i + 1} - missing required fields`);
                    }
                    if (!q.marks) {
                        q.marks = defaultMarks;
                    }
                }

                previewTest = {
                    id: Date.now(),
                    title,
                    duration,
                    questions,
                    defaultMarks,
                    negativeMarks,
                    perQuestionTimer,
                    questionTime,
                    created: new Date().toISOString()
                };

                playSuccessSound();
                showNotification('Questions loaded successfully!', 'success');
                showTestPreview();

            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function showTestPreview() {
            showScreen('preview');
            
            document.getElementById('preview-title').textContent = previewTest.title;
            
            const totalMarks = previewTest.questions.reduce((sum, q) => sum + (q.marks || previewTest.defaultMarks), 0);
            
            document.getElementById('test-info').innerHTML = `
                <h4>Test Configuration</h4>
                <div class="config-row">
                    <strong>Title:</strong> ${previewTest.title}
                </div>
                <div class="config-row">
                    <strong>Questions:</strong> ${previewTest.questions.length}
                </div>
                <div class="config-row">
                    <strong>Duration:</strong> ${previewTest.duration} minutes
                </div>
                <div class="config-row">
                    <strong>Total Marks:</strong> ${totalMarks}
                </div>
                <div class="config-row">
                    <strong>Default Marks:</strong> ${previewTest.defaultMarks} per question
                </div>
                <div class="config-row">
                    <strong>Negative Marks:</strong> ${previewTest.negativeMarks} per wrong answer
                </div>
                <div class="config-row">
                    <strong>Per-Question Timer:</strong> ${previewTest.perQuestionTimer ? `Yes (${previewTest.questionTime}s each)` : 'No'}
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 0.5rem; border-left: 4px solid var(--primary);">
                    <h5>Instructions:</h5>
                    <ul style="margin-left: 1rem; line-height: 1.6;">
                        <li>Read each question carefully before selecting an answer</li>
                        <li>You can navigate between questions using Previous/Next buttons</li>
                        <li>Mark questions for review if you're unsure</li>
                        <li>Clear your response if you want to change your answer</li>
                        ${previewTest.perQuestionTimer ? '<li><strong>Time limit per question:</strong> Each question has a time limit. If time expires, the question will be locked and cannot be answered later.</li>' : ''}
                        <li>Submit your test when completed or when time expires</li>
                    </ul>
                </div>
            `;
        }

        function startTestFromPreview() {
            if (!previewTest) return;
            
            currentTest = previewTest;
            currentQuestion = 0;
            userAnswers = {};
            questionStatus = {};
            lockedQuestions = new Set();
            timeRemaining = currentTest.duration * 60;
            questionTimeRemaining = currentTest.perQuestionTimer ? currentTest.questionTime : 0;

            currentTest.questions.forEach((_, index) => {
                questionStatus[index] = 'unvisited';
            });

            // Save test if not already saved
            if (!savedTests.find(t => t.title === currentTest.title)) {
                savedTests.push(currentTest);
                localStorage.setItem('mockTests', JSON.stringify(savedTests));
            }

            showScreen('test');
            renderQuestionNav();
            loadQuestion();
            startTimer();
            
           
                  if (currentTest.perQuestionTimer) {
            startQuestionTimer();
        }
        showNotification('Test started! Good luck!', 'success');
        }

        function startQuestionTimer() {
            const questionTimerDisplay = document.getElementById('question-timer');
            const questionTimerText = document.getElementById('question-timer-text');
            questionTimerDisplay.style.display = 'block';
            questionTimeRemaining = currentTest.questionTime;

            clearInterval(questionTimer);
            questionTimer = setInterval(() => {
                questionTimeRemaining--;
                questionTimerText.textContent = questionTimeRemaining;

                if (questionTimeRemaining <= 10 && questionTimeRemaining > 5) {
                    questionTimerDisplay.classList.add('warning');
                    questionTimerDisplay.classList.remove('critical');
                } else if (questionTimeRemaining <= 5) {
                    questionTimerDisplay.classList.add('critical');
                    questionTimerDisplay.classList.remove('warning');
                } else {
                    questionTimerDisplay.classList.remove('warning', 'critical');
                }

                if (questionTimeRemaining <= 0) {
                    clearInterval(questionTimer);
                    lockedQuestions.add(currentQuestion);
                    questionStatus[currentQuestion] = 'locked';
                    updateQuestionNav();
                    showNotification('Time up for this question!', 'warning');
                    nextQuestion();
                }
            }, 1000);
        }

        function startTimer() {
            const timerText = document.getElementById('timer-text');
            const timerDisplay = document.getElementById('timer-display');

            clearInterval(testTimer);
            testTimer = setInterval(() => {
                timeRemaining--;
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeRemaining <= 300 && timeRemaining > 60) {
                    timerDisplay.classList.add('warning');
                    timerDisplay.classList.remove('critical');
                } else if (timeRemaining <= 60) {
                    timerDisplay.classList.add('critical');
                    timerDisplay.classList.remove('warning');
                } else {
                    timerDisplay.classList.remove('warning', 'critical');
                }

                if (timeRemaining <= 0) {
                    clearInterval(testTimer);
                    if (document.getElementById('auto-submit').checked) {
                        submitTest();
                    } else {
                        showSubmitModal();
                    }
                }
            }, 1000);
        }

        function renderQuestionNav() {
            const questionNav = document.getElementById('question-nav');
            questionNav.innerHTML = '';

            currentTest.questions.forEach((_, index) => {
                const btn = document.createElement('button');
                btn.className = `question-btn ${questionStatus[index] || 'unvisited'}`;
                btn.textContent = index + 1;
                if (index === currentQuestion) {
                    btn.classList.add('current');
                }
                if (lockedQuestions.has(index)) {
                    btn.classList.add('locked');
                } else {
                    btn.onclick = () => goToQuestion(index);
                }
                questionNav.appendChild(btn);
            });
        }

        function updateQuestionNav() {
            const buttons = document.querySelectorAll('.question-btn');
            buttons.forEach((btn, index) => {
                btn.className = `question-btn ${questionStatus[index] || 'unvisited'}`;
                if (index === currentQuestion) {
                    btn.classList.add('current');
                }
                if (lockedQuestions.has(index)) {
                    btn.classList.add('locked');
                }
            });
        }

        function goToQuestion(index) {
            if (lockedQuestions.has(index)) {
                showNotification('This question is locked!', 'error');
                return;
            }
            currentQuestion = index;
            questionStatus[currentQuestion] = questionStatus[currentQuestion] || 'visited';
            loadQuestion();
            updateQuestionNav();
            if (currentTest.perQuestionTimer) {
                questionTimeRemaining = currentTest.questionTime;
                startQuestionTimer();
            }
            playClickSound();
        }

        function loadQuestion() {
            const question = currentTest.questions[currentQuestion];
            document.getElementById('question-title').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('question-text').textContent = question.question;

            const optionsList = document.getElementById('options-list');
            optionsList.innerHTML = '';

            question.options.forEach((option, index) => {
                const li = document.createElement('li');
                li.className = `option-item ${userAnswers[currentQuestion] === index ? 'selected' : ''} ${lockedQuestions.has(currentQuestion) ? 'disabled' : ''}`;
                li.innerHTML = `
                    <span class="option-radio"></span>
                    <span>${option}</span>
                `;
                if (!lockedQuestions.has(currentQuestion)) {
                    li.onclick = () => selectOption(index);
                }
                optionsList.appendChild(li);
            });

            document.getElementById('prev-btn').disabled = currentQuestion === 0;
            document.getElementById('next-btn').disabled = currentQuestion === currentTest.questions.length - 1;
        }

        function selectOption(index) {
            if (lockedQuestions.has(currentQuestion)) {
                showNotification('This question is locked!', 'error');
                return;
            }
            userAnswers[currentQuestion] = index;
            questionStatus[currentQuestion] = 'answered';
            updateQuestionNav();
            loadQuestion();
            playClickSound();
        }

        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadQuestion();
                updateQuestionNav();
                if (currentTest.perQuestionTimer) {
                    questionTimeRemaining = currentTest.questionTime;
                    startQuestionTimer();
                }
                playClickSound();
            }
        }

        function nextQuestion() {
            if (currentQuestion < currentTest.questions.length - 1) {
                currentQuestion++;
                questionStatus[currentQuestion] = questionStatus[currentQuestion] || 'visited';
                loadQuestion();
                updateQuestionNav();
                if (currentTest.perQuestionTimer) {
                    questionTimeRemaining = currentTest.questionTime;
                    startQuestionTimer();
                }
                playClickSound();
            }
        }

        function markForReview() {
            if (lockedQuestions.has(currentQuestion)) {
                showNotification('Cannot mark locked question for review', 'error');
                return;
            }
            questionStatus[currentQuestion] = 'marked';
            updateQuestionNav();
            showNotification('Question marked for review', 'success');
            playSuccessSound();
        }

        function clearResponse() {
            if (lockedQuestions.has(currentQuestion)) {
                showNotification('Cannot clear locked question', 'error');
                return;
            }
            delete userAnswers[currentQuestion];
            questionStatus[currentQuestion] = 'visited';
            updateQuestionNav();
            loadQuestion();
            showNotification('Response cleared', 'success');
            playClickSound();
        }

        function showSubmitModal() {
            const answered = Object.keys(userAnswers).length;
            const marked = Object.values(questionStatus).filter(s => s === 'marked').length;
            const unvisited = currentTest.questions.length - Object.keys(questionStatus).length + Object.values(questionStatus).filter(s => s === 'unvisited').length;

            document.getElementById('submit-summary').innerHTML = `
                <p>Answered: ${answered}</p>
                <p>Marked for Review: ${marked}</p>
                <p>Not Visited: ${unvisited}</p>
                <p>Locked Questions: ${lockedQuestions.size}</p>
            `;
            document.getElementById('submit-modal').classList.add('show');
            playClickSound();
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show'));
            playClickSound();
        }

        function submitTest() {
            clearInterval(testTimer);
            clearInterval(questionTimer);
            closeModal();

            let score = 0;
            let correct = 0;
            let incorrect = 0;
            const totalMarks = currentTest.questions.reduce((sum, q) => sum + (q.marks || currentTest.defaultMarks), 0);

            currentTest.questions.forEach((q, index) => {
                if (userAnswers[index] === q.correct) {
                    score += q.marks || currentTest.defaultMarks;
                    correct++;
                } else if (userAnswers[index] !== undefined) {
                    score -= currentTest.negativeMarks;
                    incorrect++;
                }
            });

            const percentage = totalMarks > 0 ? Math.round((score / totalMarks) * 100) : 0;
            const result = {
                testId: currentTest.id,
                title: currentTest.title,
                score,
                totalMarks,
                percentage,
                correct,
                incorrect,
                answers: { ...userAnswers },
                date: new Date().toISOString()
            };

            testResults.push(result);
            localStorage.setItem('testResults', JSON.stringify(testResults));
            currentResult = result;

            // Save to Firebase if authenticated
            if (firebaseAuth.currentUser) {
                firebaseFunctions.setDoc(
                    firebaseFunctions.doc(firebaseDB, 'results', `${firebaseAuth.currentUser.uid}_${result.testId}_${Date.now()}`),
                    result
                ).catch(error => {
                    console.error('Error saving result to Firebase:', error);
                    showNotification('Failed to save result to cloud', 'error');
                });
            }

            showScreen('results');
            displayResults();
            playSuccessSound();
            showNotification('Test submitted successfully!', 'success');
        }

        function displayResults() {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '';

            if (!currentResult) {
                resultsContent.innerHTML = '<div class="info-message">No results available. Take a test to see your results!</div>';
                return;
            }

            const resultCard = document.createElement('div');
            resultCard.className = 'card';
            resultCard.innerHTML = `
                <div class="card-header">
                    <h2>${currentResult.title}</h2>
                    <p>Test taken on ${new Date(currentResult.date).toLocaleString()}</p>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; color: var(--primary);">${currentResult.score}/${currentResult.totalMarks}</div>
                            <div style="color: var(--text-secondary);">Score</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; color: var(--success);">${currentResult.percentage}%</div>
                            <div style="color: var(--text-secondary);">Percentage</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; color: var(--success);">${currentResult.correct}</div>
                            <div style="color: var(--text-secondary);">Correct</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; color: var(--error);">${currentResult.incorrect}</div>
                            <div style="color: var(--text-secondary);">Incorrect</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="reviewTest()">Review Answers</button>
                        <button class="btn btn-secondary" onclick="showScreen('dashboard')">Back to Dashboard</button>
                    </div>
                </div>
            `;
            resultsContent.appendChild(resultCard);
        }

        function reviewTest() {
            showScreen('review');
            currentQuestion = 0;
            renderReviewQuestionNav();
            loadReviewQuestion();
        }

        function renderReviewQuestionNav() {
            const questionNav = document.getElementById('review-question-nav');
            questionNav.innerHTML = '';

            currentTest.questions.forEach((_, index) => {
                const status = userAnswers[index] === currentTest.questions[index].correct ? 'answered' : 
                              userAnswers[index] !== undefined ? 'visited' : 
                              questionStatus[index] || 'unvisited';
                const btn = document.createElement('button');
                btn.className = `question-btn ${status} ${index === currentQuestion ? 'current' : ''}`;
                btn.textContent = index + 1;
                btn.onclick = () => goToReviewQuestion(index);
                questionNav.appendChild(btn);
            });
        }

        function goToReviewQuestion(index) {
            currentQuestion = index;
            loadReviewQuestion();
            renderReviewQuestionNav();
            playClickSound();
        }

        function loadReviewQuestion() {
            const question = currentTest.questions[currentQuestion];
            document.getElementById('review-question-title').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('review-question-text').textContent = question.question;

            const status = userAnswers[currentQuestion] === question.correct ? 'CORRECT' : 
                          userAnswers[currentQuestion] !== undefined ? 'INCORRECT' : 'NOT ATTEMPTED';
            document.getElementById('review-status').textContent = status;
            document.getElementById('review-status').style.background = 
                status === 'CORRECT' ? 'var(--success)' : 
                status === 'INCORRECT' ? 'var(--error)' : 'var(--warning)';

            const optionsList = document.getElementById('review-options-list');
            optionsList.innerHTML = '';

            question.options.forEach((option, index) => {
                const li = document.createElement('li');
                li.className = `option-item ${userAnswers[currentQuestion] === index ? 'selected' : ''} ${index === question.correct ? 'correct' : ''} disabled`;
                li.innerHTML = `
                    <span class="option-radio"></span>
                    <span>${option}</span>
                `;
                optionsList.appendChild(li);
            });

            const explanation = document.getElementById('explanation');
            const explanationText = document.getElementById('explanation-text');
            if (question.explanation) {
                explanation.style.display = 'block';
                explanationText.textContent = question.explanation;
            } else {
                explanation.style.display = 'none';
            }

            document.getElementById('review-prev-btn').disabled = currentQuestion === 0;
            document.getElementById('review-next-btn').disabled = currentQuestion === currentTest.questions.length - 1;
        }

        function prevReview() {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadReviewQuestion();
                renderReviewQuestionNav();
                playClickSound();
            }
        }

        function nextReview() {
            if (currentQuestion < currentTest.questions.length - 1) {
                currentQuestion++;
                loadReviewQuestion();
                renderReviewQuestionNav();
                playClickSound();
            }
        }

        function retakeTest() {
            previewTest = currentTest;
            startTestFromPreview();
        }

        function downloadPDF() {
            // Placeholder for PDF generation (requires additional library like jsPDF)
            showNotification('PDF download feature coming soon!', 'info');
        }

        function loadMyTests() {
            const savedTestsDiv = document.getElementById('saved-tests');
            savedTestsDiv.innerHTML = '';

            if (savedTests.length === 0) {
                savedTestsDiv.innerHTML = '<div class="info-message">No tests saved yet. Create a new test to get started!</div>';
                return;
            }

            savedTests.forEach(test => {
                const testCard = document.createElement('div');
                testCard.className = 'card';
                testCard.innerHTML = `
                    <div class="card-header">
                        <h3>${test.title}</h3>
                        <p>Created: ${new Date(test.created).toLocaleDateString()}</p>
                    </div>
                    <div class="card-body">
                        <p>Questions: ${test.questions.length}</p>
                        <p>Duration: ${test.duration} minutes</p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="startSavedTest('${test.id}')">Start Test</button>
                            <button class="btn btn-error" onclick="deleteTest('${test.id}')">Delete</button>
                        </div>
                    </div>
                `;
                savedTestsDiv.appendChild(testCard);
            });
        }

        function startSavedTest(testId) {
            const test = savedTests.find(t => t.id == testId);
            if (test) {
                previewTest = test;
                startTestFromPreview();
            }
        }

        function deleteTest(testId) {
            savedTests = savedTests.filter(t => t.id != testId);
            localStorage.setItem('mockTests', JSON.stringify(savedTests));
            loadMyTests();
            showNotification('Test deleted successfully', 'success');
        }

        function loadResults() {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = '';

            if (testResults.length === 0) {
                resultsContent.innerHTML = '<div class="info-message">No results available. Take a test to see your results!</div>';
                return;
            }

            testResults.forEach(result => {
                const resultCard = document.createElement('div');
                resultCard.className = 'card';
                resultCard.innerHTML = `
                    <div class="card-header">
                        <h3>${result.title}</h3>
                        <p>Test taken on ${new Date(result.date).toLocaleString()}</p>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--primary);">${result.score}/${result.totalMarks}</div>
                                <div style="color: var(--text-secondary);">Score</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; color: var(--success);">${result.percentage}%</div>
                                <div style="color: var(--text-secondary);">Percentage</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="viewResult('${result.testId}', '${result.date}')">View Details</button>
                    </div>
                `;
                resultsContent.appendChild(resultCard);
            });
        }

        function viewResult(testId, date) {
            currentResult = testResults.find(r => r.testId == testId && r.date == date);
            currentTest = savedTests.find(t => t.id == testId);
            if (currentResult && currentTest) {
                userAnswers = currentResult.answers;
                showScreen('results');
                displayResults();
            }
        }

        // Timetable Functions
        function formatDateForSchedule(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: '2-digit' };
            return date.toLocaleDateString('en-US', options); // e.g., "Monday, September 08, 2025"
        }

        function addScheduleEntry() {
            const day = document.getElementById('schedule-day').value;
            const startTime = document.getElementById('schedule-start').value;
            const endTime = document.getElementById('schedule-end').value;
            const subject = document.getElementById('schedule-subject').value.trim();
            const notes = document.getElementById('schedule-notes').value.trim();

            if (!day || !startTime || !endTime || !subject) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (startTime >= endTime) {
                showNotification('End time must be after start time', 'error');
                return;
            }

            const entry = {
                id: Date.now(),
                day,
                startTime,
                endTime,
                subject,
                notes,
                created: new Date().toISOString()
            };

            scheduleEntries.push(entry);
            localStorage.setItem('scheduleEntries', JSON.stringify(scheduleEntries));

            if (firebaseAuth.currentUser) {
                firebaseFunctions.setDoc(
                    firebaseFunctions.doc(firebaseDB, 'schedules', `${firebaseAuth.currentUser.uid}_${entry.id}`),
                    entry
                ).catch(error => {
                    console.error('Error saving schedule to Firebase:', error);
                    showNotification('Failed to save schedule to cloud', 'error');
                });
            }

            document.getElementById('schedule-form').reset();
            showTimetableTab('today');
            updateTodaySchedule();
            showNotification('Schedule entry added successfully!', 'success');
            playSuccessSound();
        }

        function updateTodaySchedule() {
            const today = new Date();
            const todayDay = today.toLocaleString('en-US', { weekday: 'long' }).toLowerCase();
            document.getElementById('today-date').textContent = formatDateForSchedule(today);

            const todaySchedule = scheduleEntries.filter(entry => entry.day.toLowerCase() === todayDay);
            document.getElementById('today-schedule').innerHTML = generateScheduleHTML(todaySchedule, today);

            // Load Firebase schedules if authenticated
            if (firebaseAuth.currentUser) {
                showLoadingModal();
                firebaseFunctions.getDocs(
                    firebaseFunctions.query(
                        firebaseFunctions.collection(firebaseDB, 'schedules'),
                        firebaseFunctions.orderBy('created', 'desc')
                    )
                ).then(snapshot => {
                    snapshot.forEach(doc => {
                        const entry = doc.data();
                        if (!scheduleEntries.find(e => e.id === entry.id)) {
                            scheduleEntries.push(entry);
                        }
                    });
                    localStorage.setItem('scheduleEntries', JSON.stringify(scheduleEntries));
                    const updatedTodaySchedule = scheduleEntries.filter(entry => entry.day.toLowerCase() === todayDay);
                    document.getElementById('today-schedule').innerHTML = generateScheduleHTML(updatedTodaySchedule, today);
                    hideLoadingModal();
                }).catch(error => {
                    console.error('Error loading schedules from Firebase:', error);
                    hideLoadingModal();
                    showNotification('Failed to load schedules from cloud', 'error');
                });
            }
        }

        function generateScheduleHTML(entries, currentDate) {
            if (entries.length === 0) {
                return '<div class="info-message">No schedule entries for today.</div>';
            }

            const today = new Date(currentDate);
            today.setHours(0, 0, 0, 0);
            const currentTime = new Date();

            return entries.map(entry => {
                const entryDate = new Date();
                entryDate.setHours(parseInt(entry.startTime.split(':')[0]), parseInt(entry.startTime.split(':')[1]));
                const isFuture = entryDate > currentTime;

                return `
                    <div class="card schedule-entry ${isFuture ? 'locked' : ''}">
                        <div class="schedule-time">${entry.startTime} - ${entry.endTime}</div>
                        <h4>${entry.subject}</h4>
                        ${entry.notes ? `<p style="color: var(--text-secondary);">${entry.notes}</p>` : ''}
                        ${isFuture ? '' : `<button class="btn btn-primary" onclick="editScheduleEntry(${entry.id})">Edit</button>`}
                    </div>
                `;
            }).join('');
        }

        function editScheduleEntry(id) {
            const entry = scheduleEntries.find(e => e.id === id);
            if (!entry) return;

            document.getElementById('schedule-day').value = entry.day;
            document.getElementById('schedule-start').value = entry.startTime;
            document.getElementById('schedule-end').value = entry.endTime;
            document.getElementById('schedule-subject').value = entry.subject;
            document.getElementById('schedule-notes').value = entry.notes;

            scheduleEntries = scheduleEntries.filter(e => e.id !== id);
            localStorage.setItem('scheduleEntries', JSON.stringify(scheduleEntries));
            showTimetableTab('create');
        }

        function extractTodayScheduleFromHTML(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const today = new Date().toLocaleString('en-US', { weekday: 'long' }).toLowerCase();
            const schedule = [];

            // Example parsing logic (adjust based on expected HTML structure)
            const tables = doc.querySelectorAll('table');
            tables.forEach(table => {
                const rows = table.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length >= 3) {
                        const day = cells[0].textContent.trim().toLowerCase();
                        if (day === today) {
                            schedule.push({
                                id: Date.now() + Math.random(),
                                day,
                                startTime: cells[1].textContent.trim(),
                                endTime: cells[2].textContent.trim(),
                                subject: cells[3]?.textContent.trim() || 'Study Session',
                                notes: cells[4]?.textContent.trim() || ''
                            });
                        }
                    }
                });
            });

            return schedule;
        }

        function importHTMLTimetable() {
            const html = document.getElementById('html-timetable').value.trim();
            if (!html) {
                showNotification('Please paste HTML code', 'error');
                return;
            }

            try {
                const todaySchedule = extractTodayScheduleFromHTML(html);
                document.getElementById('html-content').innerHTML = html;
                document.getElementById('html-preview').style.display = 'block';

                scheduleEntries.push(...todaySchedule);
                localStorage.setItem('scheduleEntries', JSON.stringify(scheduleEntries));

                if (firebaseAuth.currentUser) {
                    todaySchedule.forEach(entry => {
                        firebaseFunctions.setDoc(
                            firebaseFunctions.doc(firebaseDB, 'schedules', `${firebaseAuth.currentUser.uid}_${entry.id}`),
                            entry
                        ).catch(error => {
                            console.error('Error saving schedule to Firebase:', error);
                            showNotification('Failed to save schedule to cloud', 'error');
                        });
                    });
                }

                showTimetableTab('today');
                updateTodaySchedule();
                showNotification('Timetable imported successfully!', 'success');
                playSuccessSound();
            } catch (error) {
                showNotification('Error importing HTML: ' + error.message, 'error');
            }
        }

        function clearHTMLTimetable() {
            document.getElementById('html-timetable').value = '';
            document.getElementById('html-content').innerHTML = '';
            document.getElementById('html-preview').style.display = 'none';
            showNotification('HTML timetable cleared', 'success');
            playClickSound();
        }

        // Notes and Live Classes Functions
        function loadNotes() {
            const notesList = document.getElementById('notes-list');
            notesList.innerHTML = '';

            if (!navigator.onLine) {
                notesList.innerHTML = '<div class="error-message">You are offline. Please check your connection.</div>';
                return;
            }

            showLoadingModal();
            firebaseFunctions.getDocs(
                firebaseFunctions.query(
                    firebaseFunctions.collection(firebaseDB, 'notes'),
                    firebaseFunctions.orderBy('uploadedAt', 'desc')
                )
            ).then(snapshot => {
                if (snapshot.empty) {
                    notesList.innerHTML = '<div class="info-message">No content yet.</div>';
                    hideLoadingModal();
                    return;
                }

                snapshot.forEach(doc => {
                    const note = doc.data();
                    const noteCard = document.createElement('div');
                    noteCard.className = 'card';
                    noteCard.innerHTML = `
                        <div class="card-header">
                            <h3>${note.title}</h3>
                            <p>Uploaded: ${new Date(note.uploadedAt).toLocaleString()}</p>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary" onclick="downloadNote('${note.url}', '${note.title}')">Download</button>
                        </div>
                    `;
                    notesList.appendChild(noteCard);
                });

                // Show upload section for admins
                if (firebaseAuth.currentUser && firebaseAuth.currentUser.email === 'admin@example.com') {
                    document.getElementById('notes-upload').style.display = 'block';
                } else {
                    document.getElementById('notes-upload').style.display = 'none';
                }

                hideLoadingModal();
            }).catch(error => {
                console.error('Error loading notes:', error);
                notesList.innerHTML = '<div class="error-message">Failed to load notes. Please try again.</div>';
                hideLoadingModal();
            });
        }

        function downloadNote(url, title) {
            if (!navigator.onLine) {
                showNotification('You are offline. Please check your connection.', 'error');
                return;
            }

            const link = document.createElement('a');
            link.href = url;
            link.download = title;
            link.click();
            showNotification('Downloading note...', 'success');
            playSuccessSound();
        }

        function uploadNote() {
            if (!firebaseAuth.currentUser || firebaseAuth.currentUser.email !== 'admin@example.com') {
                showNotification('Only admins can upload notes', 'error');
                return;
            }

            const fileInput = document.getElementById('note-file');
            const file = fileInput.files[0];
            if (!file) {
                showNotification('Please select a file', 'error');
                return;
            }

            showLoadingModal();
            const storageRef = firebaseFunctions.ref(firebaseStorage, `notes/${Date.now()}_${file.name}`);
            firebaseFunctions.uploadBytes(storageRef, file).then(snapshot => {
                return firebaseFunctions.getDownloadURL(snapshot.ref);
            }).then(url => {
                const note = {
                    title: file.name,
                    url,
                    uploadedAt: new Date().toISOString()
                };
                return firebaseFunctions.addDoc(firebaseFunctions.collection(firebaseDB, 'notes'), note);
            }).then(() => {
                fileInput.value = '';
                loadNotes();
                showNotification('Note uploaded successfully!', 'success');
                playSuccessSound();
            }).catch(error => {
                console.error('Error uploading note:', error);
                showNotification('Failed to upload note', 'error');
            }).finally(() => {
                hideLoadingModal();
            });
        }

        function loadLiveClasses() {
            const liveList = document.getElementById('live-list');
            liveList.innerHTML = '';

            if (!navigator.onLine) {
                liveList.innerHTML = '<div class="error-message">You are offline. Please check your connection.</div>';
                return;
            }

            showLoadingModal();
            firebaseFunctions.getDocs(
                firebaseFunctions.query(
                    firebaseFunctions.collection(firebaseDB, 'liveClasses'),
                    firebaseFunctions.orderBy('date', 'asc')
                )
            ).then(snapshot => {
                if (snapshot.empty) {
                    liveList.innerHTML = '<div class="info-message">No content yet.</div>';
                    hideLoadingModal();
                    return;
                }

                const now = new Date();
                snapshot.forEach(doc => {
                    const liveClass = doc.data();
                    const classDate = new Date(liveClass.date);
                    const isFuture = classDate > now;

                    const classCard = document.createElement('div');
                    classCard.className = `card schedule-entry ${isFuture ? 'locked' : ''}`;
                    classCard.innerHTML = `
                        <div class="card-header">
                            <h3>${liveClass.title}</h3>
                            <p>Scheduled: ${classDate.toLocaleString()}</p>
                        </div>
                        <div class="card-body">
                            ${isFuture ? '<p style="color: var(--text-secondary);">This class is scheduled for the future.</p>' : 
                            `<a href="${liveClass.link}" target="_blank" class="btn btn-primary">Join Class</a>`}
                        </div>
                    `;
                    liveList.appendChild(classCard);
                });

                // Show create section for admins
                if (firebaseAuth.currentUser && firebaseAuth.currentUser.email === 'admin@example.com') {
                    document.getElementById('live-create').style.display = 'block';
                } else {
                    document.getElementById('live-create').style.display = 'none';
                }

                hideLoadingModal();
            }).catch(error => {
                console.error('Error loading live classes:', error);
                liveList.innerHTML = '<div class="error-message">Failed to load live classes. Please try again.</div>';
                hideLoadingModal();
            });
        }

        function createLiveClass() {
            if (!firebaseAuth.currentUser || firebaseAuth.currentUser.email !== 'admin@example.com') {
                showNotification('Only admins can create live classes', 'error');
                return;
            }

            const title = document.getElementById('live-title').value.trim();
            const date = document.getElementById('live-date').value;
            const link = document.getElementById('live-link').value.trim();

            if (!title || !date || !link) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (!link.match(/^https?:\/\/.+/)) {
                showNotification('Please enter a valid URL', 'error');
                return;
            }

            showLoadingModal();
            const liveClass = {
                title,
                date,
                link,
                created: new Date().toISOString()
            };

            firebaseFunctions.addDoc(firebaseFunctions.collection(firebaseDB, 'liveClasses'), liveClass)
                .then(() => {
                    document.getElementById('live-title').value = '';
                    document.getElementById('live-date').value = '';
                    document.getElementById('live-link').value = '';
                    loadLiveClasses();
                    showNotification('Live class created successfully!', 'success');
                    playSuccessSound();
                })
                .catch(error => {
                    console.error('Error creating live class:', error);
                    showNotification('Failed to create live class', 'error');
                })
                .finally(() => {
                    hideLoadingModal();
                });
        }

        // Utility Functions
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            notificationText.textContent = message;
            notification.className = `notification show ${type}`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoadingModal() {
            document.getElementById('loading-modal').classList.add('show');
        }

        function hideLoadingModal() {
            document.getElementById('loading-modal').classList.remove('show');
        }

        function toggleSound() {
            soundEnabled = document.getElementById('sound-enabled').checked;
            localStorage.setItem('soundEnabled', soundEnabled);
            showNotification(`Sound effects ${soundEnabled ? 'enabled' : 'disabled'}`, 'success');
        }

        function toggleNotifications() {
            const enabled = document.getElementById('notifications-enabled').checked;
            showNotification(`Notifications ${enabled ? 'enabled' : 'disabled'}`, 'success');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                savedTests = [];
                testResults = [];
                scheduleEntries = [];
                userProfile = {
                    name: 'Guest User',
                    email: '',
                    bio: 'Quiz enthusiast ready to learn!',
                    profilePicture: null,
                    memberSince: new Date().toISOString()
                };
                localStorage.clear();
                updateProfileDisplay();
                showScreen('dashboard');
                showNotification('All data cleared', 'success');
                playSuccessSound();
            }
        }

        function toggleDesktopMode() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
                document.getElementById('desktop-icon').textContent = 'üíª';
            } else {
                document.documentElement.requestFullscreen();
                document.getElementById('desktop-icon').textContent = 'üñ•Ô∏è';
            }
            playClickSound();
        }

        // Firebase Authentication
        firebaseFunctions.onAuthStateChanged(firebaseAuth, (user) => {
            if (user) {
                userProfile.email = user.email;
                userProfile.name = user.displayName || userProfile.name;
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                document.getElementById('auth-nav').style.display = 'none';
                document.getElementById('logout-nav').style.display = 'block';
                updateProfileDisplay();
                showNotification('Logged in successfully!', 'success');
            } else {
                document.getElementById('auth-nav').style.display = 'block';
                document.getElementById('logout-nav').style.display = 'none';
            }
        });

        function login() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            document.getElementById('auth-loading').style.display = 'block';

            firebaseFunctions.signInWithEmailAndPassword(firebaseAuth, email, password)
                .then(userCredential => {
                    document.getElementById('auth-loading').style.display = 'none';
                    document.getElementById('auth-form').reset();
                    showScreen('dashboard');
                })
                .catch(error => {
                    document.getElementById('auth-loading').style.display = 'none';
                    showNotification('Login failed: ' + error.message, 'error');
                });
        }

        function signup() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value;
            document.getElementById('auth-loading').style.display = 'block';

            firebaseFunctions.createUserWithEmailAndPassword(firebaseAuth, email, password)
                .then(userCredential => {
                    return firebaseFunctions.sendEmailVerification(userCredential.user);
                })
                .then(() => {
                    document.getElementById('auth-loading').style.display = 'none';
                    document.getElementById('auth-form').reset();
                    showNotification('Account created! Please verify your email.', 'success');
                    showScreen('dashboard');
                })
                .catch(error => {
                    document.getElementById('auth-loading').style.display = 'none';
                    showNotification('Signup failed: ' + error.message, 'error');
                });
        }

        function logout() {
            firebaseFunctions.signOut(firebaseAuth)
                .then(() => {
                    userProfile.email = '';
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                    updateProfileDisplay();
                    showScreen('dashboard');
                    showNotification('Logged out successfully', 'success');
                })
                .catch(error => {
                    showNotification('Logout failed: ' + error.message, 'error');
                });
        }
    </script>
</body>
</html>